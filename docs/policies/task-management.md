# タスク管理方針

## 背景
- PR ごとの作業内容が増え、口頭共有だけでは進捗の可視化が難しくなった。
- 過去の対応履歴を追いやすくし、レビュー時に抜け漏れを防ぐ必要がある。

## 方針
- タスクを計画した段階で `docs/todo/` 配下に ToDo ファイルを作成し、作業ごとの進捗ログを残す。フロントマターには `目的`・`関連ブランチ`・`関連Issue`・`roadmap_item` を必ず記載する。
- コードへの影響がなく、ユーザーから明示的に ToDo 作成不要と指示された整備タスクは例外とし、ToDo の新規作成を省略してよい。判断に迷う場合はユーザーへ作成要否を確認する。
- ファイル名は `YYYYMMDD-<slug>.md` とし、日付と作業内容が一目で分かるようにする。
- タスクはチェックボックス形式で記述し、「誰が何をどこまで行うか」が分かる粒度で記載する。
- メモ欄は判断材料やリスクなどタスク本文に収まりきらない補足に限定し、進捗更新はチェックボックス側で行う。
- チェック項目の対象を確認した結果「更新不要」と判断した場合でも、実査完了としてチェックを付け、その判断理由をメモに残す（例: `docs/runbook は既存手順と差分なし`）。
- 完了後も PR から参照できるようにし、継続的なナレッジとして `docs/todo/archive/` に保管する。
- コミットは小さな単位で積み重ね、変更意図が追跡できる履歴を維持する。

## 新規タスク開始前チェック
- アクティブな ToDo に未完了項目が残っていないか
- 直近で完了したタスクがアーカイブおよびロードマップに反映されているか
- PR やノートなどの参照リンクが最新化されているか
- 追加の作業依頼や範囲変更が発生した場合、着手前に該当 ToDo を更新済みかを確認する
- 新規 Plan を作成する前に、対象作業の ToDo ファイルが存在し、目的・関連ブランチ・roadmap_item などのメタ情報が埋まっているか
- 作業計画（Plan）を作成し、ユーザーの承認を取得しているか

## 着手前の準備
1. `git status` がクリーンであることを確認する。
2. 作業内容に対応した ToDo と関連メモを確認し、未作成なら先に用意する。追加依頼・修正指示を受けた場合は、作業開始前に必ず該当 ToDo を更新する。Plan を作成し、ユーザーの承認（メッセージ ID やリンク）を記録する。コードに影響しない整備タスクで ToDo 省略を指示されたケースを除き、基本的に ToDo を伴う。判断に迷う場合はユーザーへ作成要否を問い合わせる。
3. 新しいブランチを `feat/<テーマ名>` などで作成し、ブランチ名を ToDo の `関連ブランチ` に記載する。
4. ブランチ作成後に作業を開始し、途中で main ブランチ上に直接コミットを作らない。

## Approval-First Development Policy
- **Plan 提示の必須化**: バグ修正・機能追加を問わず、実装前に scope／対象ファイル・モジュール／リスクと前提／テスト戦略（単体・統合など）／ロールバック方法を箇条書きでまとめた Plan を提示し、ユーザーの承認を得るまで実装を開始しない。
- **承認の記録**: 承認を得たメッセージのリンクまたは ID を ToDo や PR 説明、必要なコミット本文に明記する。Plan を変更する必要が生じた場合は作業を中断し、更新版 Plan の承認を取り直す。
- **緊急対応時の扱い**: ユーザーが緊急を指示した場合でも最小限の Plan を提示し承認を待つ。ユーザーが即時対応を明示したケースでも、後から PR などで Plan と承認の記録を必ず残す。
- **作業中の逸脱禁止**: 承認範囲を超える変更・ドキュメント更新・設定変更は行わない。追加作業が必要になった場合は Plan を再提示して承認を得る。
- **HITL 承認との連携**: 工程 3・4 の Human-in-the-Loop 承認作業では、Plan と ToDo に承認対象（`content_approved.json` / `draft_approved.json`）と必要なレビュー項目を明記し、承認ログ（メッセージ ID）を残す。承認 UI 上の差戻しや部分承認が発生した場合は ToDo やノートに記録しておく。

## PR 作成手順
1. PR 作成時は `gh pr create --fill`（または `--template`）を利用し、`.github/pull_request_template.md` を必ず反映させる。
2. テンプレート展開後に追記が必要な項目のみ手動で修正する。`--body` オプションで新規本文を指定しない。
3. ToDo やノートのリンク、コマンドログはテンプレートのチェックリストに沿って記載する。
4. スクリーンショットや PDF などの成果物がある場合は、テンプレートの動作確認欄に添付先を記入する。

## 完了手順
1. PR 作成（ドラフト解除含む）時に `todo-auto-complete` ワークフローが head ブランチ上で「PR 作成」チェックを完了にしつつ、アーカイブ移動とロードマップ反映を行う（その他の未完タスクは保持される）。ワークフローが失敗またはスキップされた場合は手動で処理し、原因を `docs/notes/` に記録する。
2. 自動処理または手動処理後、ToDo のメモに PR 番号／URL を追記して履歴を明確にする。PR を再オープンした場合は `todo-auto-complete` の再実行結果を確認する。
3. PR マージ後はローカルとリモート両方の作業ブランチを削除し、`git status` がクリーンであることを確認する。

## 運用開始手順
1. `docs/todo/` と `docs/todo/archive/` をリポジトリに用意する（既に作成済み）。
2. 作業開始時にテンプレートを参考に ToDo ファイルを新規作成する。
3. レビューや定例で進捗を確認し、必要に応じて項目を見直す。
4. 作業完了後は最終版をコミットし、アーカイブへ移動する。HITL 承認で生じたメモやログは ToDo にリンクを残す。

## テンプレート例
```
---
目的: <作業のゴール>
関連ブランチ: <作成済みブランチ名 / 未作成の場合は作成次第更新>
関連Issue: <#123 の形式で記載 / 未作成の場合は作成次第更新>
roadmap_item: RM-000 <ロードマップ上のテーマ名>
---

- [ ] タスク 1
  - メモ: 必要に応じて補足
- [ ] タスク 2

## メモ
- 作業メモ
```
