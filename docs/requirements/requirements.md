# pptx_generator 要件定義

## 1. 背景と目的
- 社内提案書を短時間で量産し、営業・コンサル部門のドキュメント作成負荷を大幅に軽減する。
- 生成物のビジュアル品質をブランドガイドラインに沿って均一化し、人的手直しを最小限に抑える。
- Mac／Linux／Windows の各環境において同一フローで運用できる自動生成基盤を提供する。

## 2. スコープ
- LLM などから得たアウトライン情報を基に PPTX を生成するサーバー／CLI 実行のワークフロー。
- 生成した PPTX の品質チェックおよび自動補正を含む。
- PDF 化を含むエクスポートと配布の最小手順。
- 監査ログ・通知・設定管理など運用面の要求。

## 3. 利用者とユースケース
- 主利用者: 営業、コンサル、提案資料を扱う社内メンバー。
- 想定ユースケース
  - 夜間に案件情報を投入し、翌朝に提案書を受領。
  - JSON 仕様を渡し、即時に下書き資料を生成してレビュー。
  - 既存資料を基に自動診断レポートを取得し、修正差分を確認。

## 4. 機能要件
1. 入力仕様管理
   - 案件情報を JSON 形式で受け取り、スライド単位のレイアウト・文章・図表・画像設定を含められること。
   - 各スライドの装飾パラメータ（フォント、色、余白、レベルなど）を案件単位で指定できること。
2. PPTX 自動生成
   - 指定テンプレート（.pptx）を基に、新規 PPTX を無人で生成すること。
   - 生成内容にタイトル、本文、箇条書き、表、チャート、画像が含められること。
   - サブタイトル・ノート・テキストボックスではブランドフォントを適用し、アンカー指定時はテンプレート図形名を維持して後続工程が再参照できること。
   - レイアウト別のスタイル（フォント、配色、フォールバック配置、段落揃え・行間・余白・インデント）を `config/branding.json` で設定し、レンダラーがブランド定義を忠実に反映すること。Polisher での仕上げはフォールバック対応と監査ログ出力に留め、段落スタイルの補正は原則レンダリング工程で完結させる。
3. 品質診断
   - 生成または既存の PPTX を解析し、余白逸脱、グリッドずれ、フォントサイズ不足、コントラスト不足、箇条書きの深さや段階ジャンプを検出すること。
   - 図形位置・サイズ・段落スタイルなど PPTX 実体から取得したメトリクスを `analysis.json` に記録し、重大度・修正案を付与すること。
4. 自動補正
   - 安全に調整可能な内容（位置スナップ、最小フォント引き上げ、色コントラスト統一、段落レベル制限など）を自動適用できること。
   - 自動補正のオン／オフや対象ルールを設定で制御できること。
5. 出力と配布
   - PPTX を保存し、任意で PDF へ変換できること。
   - 生成ファイルの保存先 URL やメタ情報を通知（Teams/Slack 想定）できること。
6. 監査・ログ
   - 入力 JSON、テンプレートバージョン、生成バージョン、ハッシュ値、処理時間などを記録すること。
   - エラー発生時には原因と再実行手順を含むログを残すこと。
7. HITL 承認フロー
   - 工程 3（コンテンツ正規化）と工程 4（ドラフト構成設計）で、人による承認・差戻し・部分承認が可能であること。
   - 承認ログには `slide_id` / `action` / `actor` / `timestamp` を記録し、後続工程とトレーサブルに連携できること。
   - 承認済みスライドはロックされ、差分生成・再レビュー時に保持されること。
8. AI レビュー支援
   - 承認前に自動レビューを実行し、グレード（A/B/C）、改善提案、Auto-fix 案を提示できること。
   - Auto-fix の適用／却下がログに残り、後から再生・監査できること。
9. テンプレ構造解析
   - `.pptx` テンプレートからレイアウト構造を抽出する CLI (`extract-template`) を提供し、工程 2 を支援すること。
   - 抽出結果には `layout_id`, `placeholders`, `text_hint`, `usage_tags`, `media_hint` を含め、工程 3〜5 が参照できること。
10. テンプレ運用サポート
   - テンプレ版ごとの差分を自動検出し、互換レポートを生成して通知できること。
   - テンプレ受け渡しメタ情報（作成者、ブランド、バージョン、レビュー日）を JSON で保存できること。
   - ゴールデンサンプル PPTX を保守し、互換性テストに再利用できること。
   - Analyzer の指摘・修正件数を `template_release.json` / `release_report.json` に集計し、品質メトリクスとして追跡できること。

## 5. 非機能要件
- パフォーマンス: 30 スライド程度の提案書を 1 分以内に生成できることを目標とする。テンプレ構造抽出は 1 ファイル 30 秒以内を目標とする。
- 可用性: 失敗時に再実行できる冪等性とジョブ管理を備えること。
- 拡張性: 追加レイアウトや新たな評価ルールを設定ファイルの変更で反映できること。
- 可観測性: 各ステップの処理時間、失敗率をモニタリングできること。
- 国際化: 日本語フォントを既定としつつ、英語への拡張が可能な構造とすること。
- クロスプラットフォーム: Mac／Linux／Windows で同一コマンドが実行できること。
- HITL 運用: 承認 UI のレスポンスは 3 秒以内、承認 1 件あたりの平均処理時間は 5 分以内を目標とする。
- AI レビュー: 自動レビューは 10 スライドあたり 30 秒以内に完了し、Auto-fix 提案の適用率を計測できること。

## 6. 運用要件
- テンプレート・ブランド設定の版管理と適用履歴の把握。
- `template_release.json`（テンプレ受け渡しメタ）と差分レポートの保管。
- CI/CD 環境で自動テストおよび自動デプロイを実行可能にすること。
- 定期的なジョブ結果通知とアラート通知を行い、一次対応手順を明文化すること。
- 生成物のストレージ保存期間（初期値 90 日）と削除ポリシーを設定すること。
- 承認ログと生成ログを相互参照し、監査時にスライド単位の変更履歴を追跡できること。

## 7. セキュリティ・コンプライアンス要件
- 入力データに含まれる機密情報を暗号化保存し、アクセス権限を RBAC で制御すること。
- LLM など外部 API を利用する際は匿名化・マスキングを行い、送信ログを保持すること。
- ライブラリの脆弱性監視を定期実施し、重大な脆弱性は迅速に是正すること。
- アクセスログに利用者 ID、操作内容、タイムスタンプを記録し、監査に対応できること。

## 8. 制約・前提
- オフィスアプリケーションを起動しないヘッドレス実行が前提。
- Python を主要言語とし、補助ツールに .NET を用いる場合はクロスプラットフォーム対応ライブラリに限定する。
- ネットワーク制限下でも基本機能が動作するよう、外部通信は設定で切り替え可能とする。
- 画像は連携済みロゴのみ使用し、外部画像取得・生成は行わない。チャート／グラフはテキストで構造化可能なデータのみ表形式で表現する。
- テンプレ改訂時は `.pptx` のみを対象とし、`extract-template` による構造抽出と互換性検証を必須とする。

## 9. 将来拡張要求 (参考)
- Office.js アドインによるワンクリック整形機能の追加。
- LLM を活用したレビューコメント生成や自動校正機能の拡張。
- 既存 PPTX から JSON 仕様を逆生成するリバースエンジニアリング機能。
- 多言語対応、画像生成連携、Keynote/Google Slides 互換出力。
- 承認ログ・生成ログ・監査ログを統合したリアルタイム監査ダッシュボード。

## 10. 未決定事項
- 正式なブランドカラー、フォント、禁則ルールの確定。
- 監査ログ保存基盤の選定と保持期間。
- 監査ログファイルの外部保存・モニタリング連携（CLI では `audit_log.json` を出力済み、基盤連携は未決）。
- LLM／視覚モデルのホスティング方式（オンプレミス／クラウド）。
- ジョブ実行プラットフォーム（Azure Functions, Container Apps, AWS Lambda, GCP Cloud Run 等）の最終決定。
- 社員向け配布ポータルの提供方法。
- テンプレ差分通知の実装方式と配信チャネル。
- HITL 承認 UI を提供するプラットフォーム（バックログ、現状は API / CLI 運用）の選定。
- Open XML Polisher と PDF 変換ジョブの配置（CLI 内包 / 外部サービス）。

## 11. 工程別詳細ドキュメント
| 工程 | 詳細設計ドキュメント | 主な未実装項目の例 |
| --- | --- | --- |
| 1 テンプレ準備 | [stage-01-template-preparation.md](./stages/stage-01-template-preparation.md) | テンプレ差分レポート、受け渡しメタ生成、ゴールデンサンプル自動検証 |
| 2 テンプレ構造抽出 | [stage-02-template-structure-extraction.md](./stages/stage-02-template-structure-extraction.md) | JSON スキーマ検証、差分可視化、ヒント係数推定 |
| 3 コンテンツ正規化 | [stage-03-content-normalization.md](./stages/stage-03-content-normalization.md) | 承認 API（UI はバックログ）、AI レビューと Auto-fix、禁則チェック |
| 4 ドラフト構成設計 | [stage-04-draft-structuring.md](./stages/stage-04-draft-structuring.md) | layout_hint 管理 API、スコアリング、多様性ログ・付録操作履歴 |
| 5 マッピング | [stage-05-mapping.md](./stages/stage-05-mapping.md) | スコアリング/フォールバック制御、AI 補完監査、スキーマ検証 |
| 6 PPTX 生成 | [stage-06-rendering.md](./stages/stage-06-rendering.md) | 軽量整合チェック、監査メタ拡張、PDF/Polisher 統合 |
