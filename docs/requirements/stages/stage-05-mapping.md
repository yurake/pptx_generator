# 工程5 マッピング 要件詳細

## 概要
- 承認済みドラフトとテンプレ構造を統合し、レンダリング準備 JSON を生成する。
- ルールベースと AI 補完を組み合わせ、プレースホルダへの要素割付を完了させる。

## 入力
- `draft_approved.json`: 章構成、スライド順、`layout_hint`。
- `content_approved.json`: テキスト・表・意図タグ。
- `layouts.jsonl`, `diagnostics.json`: レイアウト構造と警告情報。

## 出力
- `rendering_ready.json`: スライドごとの `layout_id`、PH → 要素マッピング、メタ情報。
- `mapping_log.json`: スコアリング結果、AI 補完箇所、フォールバック履歴。
- 失敗レポート: 未割付要素や収容不能スライドの一覧。

## ワークフロー
1. レイアウト候補を用途タグと必須要素でフィルタし、スコアリングを実施する。
2. ルールベースで一次割付を行い、空要素を抽出する。
3. AI 補完で未割付や冗長要素を再配分し、必要に応じてスライド分割・縮約を行う。
4. フォールバックルール（縮約 → 分割 → 付録）を適用し、その履歴を記録する。
5. JSON スキーマ検証を通過した `rendering_ready.json` を出力し、工程6へ送る。

## 品質ゲート
- 全スライドが `layout_id` を持ち、必須 PH が埋まっている。
- `rendering_ready.json` がスキーマ検証を通過し、空要素は意図的であるとログに記載される。
- フォールバック適用時に理由が `mapping_log.json` に記録されている。
- AI 補完結果が監査ログに明示され、後追い確認が可能である。

## ログ・監査
- 候補レイアウトのスコア（必須充足・容量適合・用途タグ・多様性）を保持する。
- AI 補完前後の差分を記録し、自動修正率を算出できるようにする。
- 収容不能ケースはエラー扱いとし、再実行のためのチェックリストを添付する。

## 未実装項目（機能単位）
- レイアウトスコアリングとフォールバック制御ロジック。
- AI 補完の差分記録と監査ログ連携。
- `rendering_ready.json` スキーマ検証ツールと失敗時ガイド生成。
