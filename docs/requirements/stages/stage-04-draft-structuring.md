# 工程4 ドラフト構成設計 (HITL) 要件詳細

## 概要
- 承認済みコンテンツを章立て・スライド順に配置し、`layout_hint` を確定させる。
- HITL 承認により構成をロックし、後続工程に安定した入力を提供する。

## 入力
- 工程3の `content_approved.json`（`story.phase` / `story.chapter_id` / `story.angle` を含む）。
- 工程2の `layouts.jsonl`（利用可能なレイアウトカテゴリのヒント）。
- 制約情報（本編枚数上限、章構成テンプレ、付録方針）。

## 出力
- `draft_approved.json`: 章構成、スライド順、`layout_hint`、付録フラグ。
- 承認ログ: 章/スライド単位の承認・差戻し履歴。
- レイアウト候補一覧と選定理由を含む提案ログ。

## ワークフロー
1. Draft API / CLI が章レーンとスライドカードの構成データを提示する。
2. AI が提案する構成案をベースに、人が CLI / 外部ツールから順序や章を調整する。
3. `layout_hint` を選択し、必要に応じて付録送りや統合を行う。
4. 承認単位（章・スライド）で承認フラグを更新し、差戻し理由を記録する。
5. 承認完了後に `draft_approved.json` を出力し、工程5へ渡す。

## 品質ゲート
- すべてのスライドが章に所属し、章順が定義されている。
- 工程3のストーリーフェーズ情報と章構成が整合している（不一致は差戻しまたは章調整を実施）。
- `layout_hint` が未設定のスライドが存在しない。
- 本編枚数が制約内に収まっている（超過は付録へ移動済み）。
- 承認ログが揃い、差戻し理由が空欄でない。

## ログ・連携
- 承認イベントログと工程3ログを `slide_uid` で突合可能にする。
- レイアウト候補のスコア（用途タグ一致率、容量適合度、多様性）を記録する。
- 付録送り・統合の履歴を残し、後続のマッピングで参照する。

## 未実装項目（機能単位）
- 構成管理 API（UI はバックログ）と `layout_hint` 管理機能。
- 多様性を考慮したレイアウト候補スコアリング。
- 付録送り・統合操作の履歴管理と再承認フロー。
- `story_outline` と `layout_hint` の整合チェックおよび警告表示。
