# RM-033 パイプライン工程3/4独立化 概要整理（2025-10-19）

> **補足:** 2025-11 に `pptx gen` は工程5専用コマンドへ再定義済み。本メモは再定義前の状況整理として残している。

## 現状確認
- CLI `pptx gen` は工程3〜5を一括実行しつつ、内部で `ContentApprovalStep`（工程3）→`DraftStructuringStep`＋`MappingStep`（工程4）→`SimpleRendererStep`（工程5）などを順に呼び出している。
- 直近のリファクタで `pptx compose`（工程4一括）、`pptx mapping`（工程4後半）、`pptx render`（工程5）が追加済み。`pptx render` は `generate_ready.json` を唯一の主要入力とし、`generate_ready_to_jobspec()` を介して JobSpec を再構築する。
- 工程3/4は CLI として完全分離されておらず、`pptx mapping` 実行時にも `ContentApprovalStep` と `DraftStructuringStep` が走る（指定がなければスキップする構成）。
- `ContentApprovalStep` は承認済み JSON とレビュー ログを読み込むだけで生成処理は持たず、HITL で整備済みのファイルを前提にしている。
- `DraftStructuringStep` は `content_approved` アーティファクトと `layouts.jsonl` を元に `draft_draft.json` / `draft_approved.json` を生成し、`DraftStore` へも登録するため、工程4独立実行時の副作用 (draft 出力とメモリ内ストア) を想定済み。
- テストは `tests/test_cli_integration.py` が `pptx gen` を中心に検証しており、`pptx mapping` / `pptx render` 単体のシナリオは未整備。

## 課題とスコープ案
- 工程3/4を個別 CLI として提供するため、既存ステップを呼び出すコマンドの追加と入出力定義を整理する必要がある。
- 想定コマンド: `pptx content` で `content_draft.json` から `content_approved.json` を検証/整形、`pptx outline` で `content_approved.json` から `draft_approved.json` を生成。
  - いずれも生成内容のバリデーションと、既存ステップ/API との整合を重視する。
- CLI 分離に合わせて README/設計/要件ドキュメントへ工程3/4専用コマンドの導線を追記する必要がある。
- 監査ログ (`audit_log.json`) では工程3/4専用 CLI を通じて得たメタ情報（ハッシュ、スライド数、ログ件数など）を記録できるよう整理が必要。
- テスト戦略として、`pptx content` → `pptx outline` → `pptx mapping` → `pptx render` のチェーンと、`pptx outline` 単体再実行時のシナリオを追加する。
- HITL 運用とのギャップ（承認データは手動整備前提）を埋めるため、CLI で最低限の検証・補助機能（必須項目チェック、整合警告）を提供するか判断する必要がある。

## オープン事項
- 工程3 CLI がどこまで自動補完を行うか（完全自動生成か、検証＋フォーマッタに留めるか）。
- DraftStore（`src/pptx_generator/api/draft_store.py`）の永続化戦略。現状はメモリストアであり、CLI を複数回実行すると最後の内容のみ保持される。
- Review Engine 連携（`review_engine_analyzer.json`）を工程3 CLI でどのように扱うか。現状は工程5後のアダプタ出力で補完している。
- 既存 `pptx gen` との互換性をどう維持するか（内部的に新 CLI を呼び出すか、ステップを直接実行するか）。

## 次ステップ
1. 工程3/4 CLI のコマンド設計（引数・入出力・副作用）とバリデーションポリシーをまとめる。
2. 監査ログ・アーティファクトの扱いを整理し、`PipelineContext` から CLI 実行結果を流用できるようにする。
3. テスト計画とドキュメント更新範囲を洗い出し、ToDo チェックリストへ反映する。
