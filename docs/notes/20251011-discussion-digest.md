# 2025-10-10 ディスカッション整理メモ

本メモは `docs/notes/20251010-discussion-new-loadmap.txt` の内容を後続の要件・設計・実装で参照しやすいように整理したもの。ロードマップ再設計以外の論点を抜粋し、決定事項と検討メモをまとめる。

> 現在の開発方針では専用 UI の実装は後続フェーズに延期し、当面は API／CLI を前提に HITL 承認を運用する。以下で触れる UI 案はバックログ扱いとする。

## 1. テンプレート資産とメタ管理
- **構成指針**
  - `/templates/libraries/<brand>/<version>/template.pptx` を基盤とし、サムネイル・使用例・manifest を随時追加。
  - `/schemas/` に layout manifest / content mapping の JSON Schema、CI 用リンター (`validate_manifest.py`) を配置。
  - `/tools/export_layouts.py` でレイアウト一覧を抽出し、manifest と差分突合。
- **命名規約**
  - レイアウト名: `[カテゴリ]__[機能]__[要素]__[バリアント]`（例 `KPI__Scorecard__3colsSmall__A`）。
  - プレースホルダ名: `PH__[役割]__[順序/位置]`（例 `PH__Title__1`, `PH__Body__Main`）。
  - プレースホルダ種別の標準セット: `title`, `subtitle`, `heading`, `body`, `note`, `image`, `chart`, `icon`, `table`, `label`。
- **運用ポイント**
  - テンプレ作成（工程1）では PPTX 本体のみ整備し、メタ抽出は工程2に委譲。
  - バージョン管理は PPTX ファイル名で実施し、互換性の判定は構造抽出結果で行う。
  - テンプレ更新差分を自動検出して通知（欠落 PH、名称変更、構造変更）し、旧バージョンとの互換レポートを生成する。
  - 図形の直描きは避け、必ずプレースホルダ配置で後段抽出を安定化させる。

## 2. 全体アーキテクチャ
- **入力面**: ユーザー指定の目的・ターゲット・必須メッセージ・素材データ、およびブランド別テンプレライブラリ。
- **中核モジュール**
  1. テンプレインデクサ（マスター解析とレイアウトカタログ化）
  2. コンテンツ生成器（素材テキスト・表・指示文の生成）
  3. レイアウト選定エンジン（要件→レイアウトの自動マッチング）
  4. ドラフト組版器（章立て・ページ順の自動提案）
  5. 中間 JSON アセンブラ（プレースホルダ割付）
  6. PPTX レンダラ（テンプレを適用して最終 PPTX を生成）
- **出力面**: 最終 PPTX、ドラフト PPTX、各種中間 JSON、採用レイアウト一覧、生成ログ。
- **MVP スコープ**: 固定ブランド／日本語／16:9、レイアウトカテゴリは 5 種（タイトル・セクション・1カラム・2カラム・KPIカード）から開始。
- **中長期追加**: 画像/チャートの高度化、API 化、UI ダッシュボード、監査ログ API、通知連携。

## 3. 工程別詳細仕様（1〜6）

### 1. テンプレ作成（ライブラリ準備）
- **オペレーション**: 自動（テンプレ編集作業のみ人手）
- **目的**: ブランドごとの PPTX テンプレ資産を整備し、後工程がそのまま利用できる状態にする。
- **入力**: ブランドガイド、既存社内テンプレ、ベストプラクティス例。
- **出力**: `templates/libraries/<brand>/<version>/template.pptx`（スタイル・レイアウトを含むテンプレ本体のみ）。
- **処理概要**:
  1. スライドマスター／レイアウトの設計・改修。
  2. フォント・配色・段落・図形配置の調整。
  3. プレースホルダ配置（PH 名は命名規約に従い、PH 以外の直描きを避ける）。
  4. 簡易ビジュアル検証（崩れや重なりの目視確認）。
- **制約・フォールバック**:
  - メタデータ（レイアウト構造・用途タグ）は出力しない。抽出は工程2で実施。
  - 後段の機械抽出が可能なように、PH はマスター階層に配置し、不要図形を作らない。
  - 版管理はファイル名で行い、互換性検証は工程2で対応。
- **主要 I/F**: 受け渡しは PPTX 本体のみ。差分通知はテンプレ版の比較レポートとして別途生成。
- **完了基準**: 想定レイアウトがすべて盛り込まれ、崩れのない PPTX が用意されていること（工程2で 100% 抽出可能）。

### 2. テンプレ構造抽出
- **オペレーション**: 自動
- **目的**: PPTX からレイアウト構造・用途タグ・ヒント値を機械抽出し、後工程が利用できる JSON を作る。
- **入力**: テンプレ PPTX、本工程用の抽出ルール（PH 種別マッピング、面積→ヒント係数など）。
- **出力**:
  - `layouts.jsonl`（1 レイアウト＝1 行、`template_id`, `layout_id`, `placeholders[]`, `text_hint`, `media_hint`, `usage_tags`, `version`）。
  - `diagnostics.json`（`warnings[]`, `errors[]`：抽出不能・欠損レイアウトを記録）。
- **処理概要**:
  1. スライドマスター配下のレイアウト列挙。
  2. PH 抽出と型付け（title/body/subtitle/image/table/chart/note 等）。
  3. 面積・既定フォント・行間からテキスト推奨レンジを算出（短/中/長カテゴリ）。
  4. 画像・表 PH の推奨アスペクト比／解像度を記録。
  5. 抽出内容を JSON 化し、差分検知で旧版との互換性を判定。
- **制約・フォールバック**:
  - 収容目安はヒントであり制約ではない（はみ出しは後工程で調整）。
  - 抽出不能 PH は `type=body_generic` として扱い、スコア劣後。
  - 必須 PH 欠落（例: title 無し）のレイアウトは候補落ちとして診断ログに記録。
- **主要 I/F**: 上記 JSON。スキーマ検証に合格したもののみ工程3以降に渡す。
- **完了基準**: 全レイアウト抽出成功（または候補落ちが明示）、JSON スキーマに合格、差分レポートで互換性が確認できること。

### 3. コンテンツ作成（素材生成＋HITL）
- **オペレーション**: 自動生成（draft）＋ AI レビュー ＋ HITL 承認
- **目的**: 入力データからスライド候補を構造化し、ユーザーが内容を調整・承認した `content_approved.json` を得る。
- **入力**:
  - ユーザーデータ（テキスト／Markdown／CSV／Excel／JSON 等）。
  - コンテキスト条件（目的、対象読者、トーン、想定枚数/時間）。
  - テンプレ構造情報（工程2出力の用途タグや layout ヒント）。
- **出力**:
  - 自動出力: `content_draft.json`（AI が生成したスライド候補）。
  - HITL 承認後: `content_approved.json`（タイトル・本文・表・注記・intent を確定）。
  - 差分／承認ログ: `content_review_log.json`（変更履歴、承認イベント）。
- **処理概要**:
  1. **自動生成**: 入力整形 → 主要メッセージ抽出 → スライド候補生成（title/body/note/table-data）→ intent/type_hint 付与。
  2. **AI レビュー**（詳細は §6 を参照）: 明瞭性・冗長性・定量整合などをチェックし、サマリー／改善提案／Auto-fix を出力。
  3. **HITL 承認**: カード UI で文面・表を編集、意図タグ変更、不要スライド削除・統合。部分承認・差戻し・付録送りをサポート。
  4. 承認済みスライドはロックし、未承認スライドのみ再生成が可能。
- **制約・フォールバック**:
  - 画像生成・外部画像挿入は不可（ロゴのみ自動挿入可）。チャートは構造化テキストを表形式で表現。
  - 情報欠損時は `<データ不足>` などのプレースホルダを残し、AI レビューで警告。
  - 文字量超過・冗長表現は後段で調整できるため、意味保持を優先しつつ改善提案で短縮可能。
- **主要 I/F**:
  - `content_draft.json` ⇄ UI（AI が人向け表示へ変換）。
  - `content_approved.json`（工程4の唯一の入力）。
  - `content_review_log.json`（承認イベント、AI レビュー結果、Auto-fix 適用状況）。
- **完了基準**:
  - すべてのスライド候補に `title` と本文（1 要素以上）・`intent` が存在。
  - 承認済みスライドのみが `content_approved.json` に含まれ、スキーマ検証に合格。
  - 承認ログに未解決の警告が残っていない（警告は明示的に保留可）。

### 4. ドラフト構成設計（HITL）
- **オペレーション**: 自動組版案生成 ＋ AI レビュー ＋ HITL 承認
- **目的**: 章立て・ページ順・layout_hint を確定し、`draft_approved.json` を出力する。
- **入力**:
  - `content_approved.json`（工程3の承認結果）。
  - テンプレ構造情報（工程2出力）。
  - プレゼン方針（目的、枚数レンジ、構成テンプレート）。
- **出力**:
  - 自動出力: `draft_draft.json`（AI が生成した章構成案）。
  - HITL 承認後: `draft_approved.json`（章→スライド順、layout_hint 付き）。
  - 差分／承認ログ: `draft_review_log.json`。
- **処理概要**:
  1. **自動組版**: intent/type_hint をクラスタリングし、構成テンプレート（報告型/提案型 等）に当て込んで章順・スライド順を生成。
  2. **AI レビュー**: 章テンプレ適合、冗長・欠落、layout_hint 妥当性、付録候補を評価し提案。
  3. **HITL 承認**: ストーリーボード UI で章名編集、スライド移動、付録送り、layout_hint 変更を実施。部分承認あり。
  4. 承認済みスライドはロックされ、工程5では `draft_approved.json` のみ利用。
- **制約・フォールバック**:
  - 本編枚数が上限レンジ内に収まらない場合は自動で付録レーンへ退避提案。
  - layout_hint 未設定のスライドは承認不可。AI が提案しても人が最終確定。
  - 冗長な章は統合提案され、C 評価の場合は差戻し。
- **主要 I/F**:
  - `draft_draft.json` ⇄ UI。
  - `draft_approved.json`（工程5の入力）。
  - `draft_review_log.json`（承認イベント、AI レビュー結果）。
- **完了基準**:
  - すべてのスライドが章に所属し、page_no と layout_hint が確定。
  - `draft_approved.json` がスキーマ検証に合格し、付録／本編区分が明示。
  - 承認ログに保留状態が残っていない。

### 5. マッピング（ドラフト×テンプレ情報統合）
- **オペレーション**: 自動（ルール＋AI 補完）
- **目的**: 承認済みドラフトとテンプレ構造を用いて、PH ごとの要素割り当てを確定したレンダリング準備 JSON を生成する。
- **入力**:
  - `draft_approved.json`（章構造・layout_hint）。
  - `layouts.jsonl` / `diagnostics.json`（工程2出力）。
  - `content_approved.json`（タイトル・本文・表 等）。
- **出力**:
  - `rendering_ready.json`（各スライドに `layout_id`, `elements`, `meta` を付与）。
  - `mapping_log.json`（レイアウト選定得点、AI 補完箇所、フォールバック履歴）。
- **処理概要**:
  1. **一次マッピング（ルールベース）**: layout_hint と用途タグで候補レイアウト抽出 → PHと要素のマッピング表で自動割付 → スコアリングで最適レイアウト決定。
  2. **AI 補完（二次処理）**: 未割付や曖昧要素を生成AIが再配置（要約・統合含む）。出力は JSON スキーマで検証。
  3. **整形**: 文章の短縮・補強、表フォーマット統一、セクション情報付与（page_no、section 名）。
  4. **ログ化**: レイアウト選定理由、AI 補完箇所、フォールバック（縮約→分割→付録）を記録。
- **制約・フォールバック**:
  - 必須要素を満たさないレイアウトは自動的に候補落ちとして次点を試行。
  - 収容不能の場合は順に「文章縮約 → スライド分割 → 付録送り」を適用し、結果をログ化。
  - AI 補完は安全な変更のみ採用し、複数候補がある場合は用途タグ一致率と直前スライド多様性で決定。
- **主要 I/F**: `rendering_ready.json`（工程6の唯一の入力）、`mapping_log.json`（監査・検証用）。
- **完了基準**:
  - 全スライドに `layout_id` と必要要素が割付済み。
  - `rendering_ready.json` がスキーマ検証に合格し、空要素は意図的かつログ化されている。
  - ログに重大エラーがなく、AI 補完が明示されている。

### 6. PPTX 生成（レンダリング＋軽量整合チェック）
- **オペレーション**: 自動
- **目的**: テンプレ PPTX と `rendering_ready.json` を用いて最終 `output.pptx` を生成し、軽量整合チェックと生成ログを出力する。
- **入力**:
  - `rendering_ready.json`。
  - テンプレ PPTX（工程1）。
  - ロゴアセット（任意）。
- **出力**:
  - `output.pptx`。
  - `rendering_log.json`（テンプレ版、使用 layout_id、挿入要素数、削除/スキップ要素、表サイズ、警告一覧）。
- **処理概要**:
  1. テンプレ PPTX を基にドキュメント初期化、セクション生成。
  2. スライドを追加し、タイトル／本文／表／注記／ロゴを各 PH に挿入。
  3. ノート欄・フッター等のテンプレ設定を反映。
  4. **軽量整合チェック**: 空要素・空表・レイアウト不一致・過剰改行を検出し、必要に応じて削除または警告記録。
  5. ファイル保存とログ出力（処理時間、警告件数、差し戻し推奨箇所）。
- **制約・フォールバック**:
  - テンプレの書式を上書きしない。表がはみ出す場合は列幅調整 → 限界超過時は画像化し注記に記録。
  - 未使用 PH はテンプレ仕様に応じて空処理または非表示化。
  - 空要素検知や layout_id ミスマッチは警告としてログ化し、必要に応じて再処理・差戻し。
- **主要 I/F**: `output.pptx`, `rendering_log.json`（監査・失敗解析用）。
- **完了基準**:
  - 全スライドが生成され、主要要素が正しい PH に挿入済み。
  - `output.pptx` が正常に開けること。
  - 生成ログに重大エラーがなく、警告は明示的に整理されている。

## 4. レイアウト選定エンジン
- **スコアリング要素**
  1. 必須要素の合致度（必須 PH の有無、要素数一致）
  2. 容量適合（文字量・表サイズ・画像アスペクト）
  3. 文脈適性（用途タグ: KPI/ロードマップ/比較 等）
  4. ブランド・言語適合（フォント・書字方向・色）
  5. 美観・一貫性（類似レイアウト連続回避）
- **アウトプット**: 候補レイアウトをスコア順に提示し、採用理由を説明可能にする。
- **関連アーティファクト**
  - レイアウトカタログ JSON（layout_id、placeholders、tags、ヒント値）。
  - ページ要件 JSON（intent、needs、content）。
  - 割付 JSON （layout_id と placeholder→値のマッピング）。
- **フォールバック**: 同点候補のタイブレーク（必須 PH 完全一致 → 文字収容率 → バリエーション → 優先順位）、収容不能時の縮約→分割→付録落とし。

## 5. 非機能・運用要件（概説）
- **バージョニング**: テンプレ／レイアウト定義／プロンプトをバージョン管理し、差分抽出を自動化。
- **多言語対応**: フォント置換・禁則・右左書字のポリシーを定義（初期リリースは日本語に限定）。
- **アクセシビリティ**: コントラスト、読み上げテキスト、代替テキスト生成を中長期で検討。
- **パフォーマンス**: 30 枚資料を 60 秒以内、テンプレ解析は 1 ファイル 30 秒以内。
- **セキュリティ**: 機微情報のマスク、NG ワード検査、メタデータ監査を実装候補に挙げる。
- **監査**: 生成時のテンプレ版、layout_id、処理ログ、差分を記録。
- **残課題**: 枚数と付録境界、縮約優先順位、禁則辞書・許可辞書、多言語対応範囲の調整。
- **運用タスク**: ゴールデンサンプル PPTX の維持、テンプレ差し替え時の自動検証ジョブ、失敗時のリトライ設計（再生成時間 5 分以内を目標）。

## 6. HITL（工程3・4）の方針
- **承認ポイント**
  - (3) コンテンツ承認: スライド候補単位でタイトル・本文・表・意図タグを確定。
  - (4) ドラフト承認: 章立て・ページ順・layout_hint を確定し、付録送り／統合を判断。
- **承認ゲート基準**
  - (3): `title` と本文が存在する、intent 設定済み、数値・単位が明確。
  - (4): 全スライドが章に所属、本編枚数が上限内、各スライドに layout_hint がある。
  - 未充足は承認ボタンを非活性化し、理由を可視化。
- **承認 UI イメージ**
  - 3: コンテンツボード（カード表示、AI アシストで要約/拡張/箇条書き化、表の直接編集、意図タグのプルダウン、承認／付録へ／削除／統合ボタン）。
  - 4: ストーリーボード（章レーンとスライドカード、ドラッグで順番や章を変更、layout_hint の候補表示、付録への移動ボタン）。
- **部分承認とロック**: 承認済み要素はロックし再生成で上書きしない。差戻し時は未承認部分のみ再生成。
- **役割と権限**: Editor（編集・部分承認）、Approver（最終承認）、Viewer（閲覧）を想定。
- **ログ**: 承認イベント（誰がいつ何を確定）と差戻し理由を記録し、slide_uid で工程間トレース。
- **差戻しフロー**: 問題カードにピン留めし、再生成対象を特定。承認保留や付録化提案をUI上で提示。
- **レビュー UI 共通要素**: 差分表示、警告バッジ、ショートカット操作（短く/長く/箇条書き化 等）、編集履歴とロールバック、承認ボタンの活性化制御。

## 7. AI レビュー挿入案
- **位置づけ**: 3/4 のユーザー承認前に AI レビューを自動実行し、合格で承認 UI へ、不合格は改善提案付きで差戻し。
- **レビュー出力形式**
  1. サマリー（グレード、強み/改善点）
  2. 改善アクション（スライド単位のパッチ、適用/却下ボタン付き）
  3. リスク・警告（曖昧語、単位抜け、冗長等）
  4. Auto-fix セット（安全な軽微修正のみワンクリック適用）
- **評価レベル**
  - A: 軽微修正 → 承認 UIへ。
  - B: 要改善 → Auto-fix 適用かユーザー修正。
  - C: 不合格 → 自動リライト案付きで差戻し、対象スライドのみ再レビュー。
- **チェック観点**
  - 3: 明瞭性、簡潔性、一貫性、定量の健全性、構造化適切性、トーン適合。
  - 4: 章テンプレ適合、流れ、冗長/欠落、枚数バランス、layout_hint 妥当性。
- **実装メモ**
  - 静的チェッカー（必須項目、書式、数値整合）＋ LLM クリティークのハイブリッド。
  - 変更は必ず「提案→ユーザー適用」で行い、自動上書きを避ける。
  - 再レビューは差分のみ対象とし、Auto-fix の結果も再検証する。
- **メトリクス例**: Auto-fix 適用率、再レビュー回数、承認後の差戻し率。

## 8. 共通制約とフォールバックポリシー
- **画像・チャート**
  - 画像生成／外部取得は禁止。ロゴ配置のみ自動化。
  - チャートはテキストや表から構造化できる場合に限り表形式で表現し、非構造データは本文として保持。
- **テンプレ依存スタイル**
  - フォント・色・段落はテンプレ側で完結。後工程でスタイルを上書きしない。
- **出力の揺らぎ**
  - LLM による自然な表現差を許容。構造・章立て・枚数は安定させる。
- **フォールバック階層**
  1. 文章側調整（要約／補強／箇条書き化）
  2. 書式調整（フォントサイズ・行間・段落）
  3. レイアウト切替（似た構造のテンプレへチェンジ）
  4. 構成調整（分割／付録送り／省略）
- **失敗時の扱い**
  - レイアウト不一致・PH 欠落は候補落ちとしてログ化。
  - 収容不能は縮約→分割→付録を自動適用し、ユーザーには結果を提示。
  - 5→4 差戻し時には問題スライドに対処ガイドを表示。

## 9. UI/UX に対する要求
- JSON は内部形式とし、ユーザーには自然言語・カード UI・グラフィカルな操作のみ提供。
- AI は「人が理解できる表現」への変換と、編集内容を内部 JSON に戻す通訳役に徹する。
- レビュ UI の必須要素: 差分表示、警告バッジ、ショートカット操作、承認済み要素のロック、履歴とロールバック、再生成トリガー。
- ユーザー補助: AI の提案（短く・詳しく・比較用に整形・意図変更）、表の自動列名提案、単位統一。
- 失敗時フォールバック: タイムアウトは保留扱い、必須項目欠落は承認不可、構成オーバーは付録送り/統合を提案。

## 10. 今後のドキュメント化・タスク化のヒント
- 組織向けテンプレ整備ガイド（命名規約・検証手順）を `docs/policies` 系に追加。
- レイアウト選定エンジンとスコアリング指標の詳細設計を `docs/design/` に展開。
- HITL 承認ワークフロー（状態遷移・権限・UI仕様）の別紙化。
- AI レビューのプロンプト雛形と結果スキーマの定義。
- 非機能要件（性能・セキュリティ・監査）の数値指標とテスト方針を `docs/requirements/` へ反映。
- 承認ログと生成ログを連携させ、監査レポートテンプレートを用意（承認履歴、差分、Auto-fix 適用状況を一覧化）。
- UI ワイヤーやユーザーフロー図を作成し、`docs/design/` で共有できるようにする。
