# 2025-10-10 ディスカッション整理メモ

本メモは `docs/notes/20251010-discussion-new-loadmap.txt` の内容を後続の要件・設計・実装で参照しやすいように整理したもの。ロードマップ再設計以外の論点を抜粋し、決定事項と検討メモをまとめる。

## 1. テンプレート資産とメタ管理
- **構成指針**
  - `/templates/libraries/<brand>/<version>/template.pptx` を基盤とし、サムネイル・使用例・manifest を随時追加。
  - `/schemas/` に layout manifest / content mapping の JSON Schema、CI 用リンター (`validate_manifest.py`) を配置。
  - `/tools/export_layouts.py` でレイアウト一覧を抽出し、manifest と差分突合。
- **命名規約**
  - レイアウト名: `[カテゴリ]__[機能]__[要素]__[バリアント]`（例 `KPI__Scorecard__3colsSmall__A`）。
  - プレースホルダ名: `PH__[役割]__[順序/位置]`（例 `PH__Title__1`, `PH__Body__Main`）。
  - プレースホルダ種別の標準セット: `title`, `subtitle`, `heading`, `body`, `note`, `image`, `chart`, `icon`, `table`, `label`。
- **運用ポイント**
  - テンプレ作成（工程①）では PPTX 本体のみ整備し、メタ抽出は工程②に委譲。
  - バージョン管理は PPTX ファイル名で実施し、互換性の判定は構造抽出結果で行う。
  - テンプレ更新差分を自動検出して通知（欠落 PH、名称変更、構造変更）し、旧バージョンとの互換レポートを生成する。
  - 図形の直描きは避け、必ずプレースホルダ配置で後段抽出を安定化させる。

## 2. 全体アーキテクチャ
- **入力面**: ユーザー指定の目的・ターゲット・必須メッセージ・素材データ、およびブランド別テンプレライブラリ。
- **中核モジュール**
  1. テンプレインデクサ（マスター解析とレイアウトカタログ化）
  2. コンテンツ生成器（素材テキスト・表・指示文の生成）
  3. レイアウト選定エンジン（要件→レイアウトの自動マッチング）
  4. ドラフト組版器（章立て・ページ順の自動提案）
  5. 中間 JSON アセンブラ（プレースホルダ割付）
  6. PPTX レンダラ（テンプレを適用して最終 PPTX を生成）
- **出力面**: 最終 PPTX、ドラフト PPTX、各種中間 JSON、採用レイアウト一覧、生成ログ。
- **MVP スコープ**: 固定ブランド／日本語／16:9、レイアウトカテゴリは 5 種（タイトル・セクション・1カラム・2カラム・KPIカード）から開始。
- **中長期追加**: 画像/チャートの高度化、API 化、UI ダッシュボード、監査ログ API、通知連携。

## 3. レイアウト選定エンジン
- **スコアリング要素**
  1. 必須要素の合致度（必須 PH の有無、要素数一致）
  2. 容量適合（文字量・表サイズ・画像アスペクト）
  3. 文脈適性（用途タグ: KPI/ロードマップ/比較 等）
  4. ブランド・言語適合（フォント・書字方向・色）
  5. 美観・一貫性（類似レイアウト連続回避）
- **アウトプット**: 候補レイアウトをスコア順に提示し、採用理由を説明可能にする。
- **関連アーティファクト**
  - レイアウトカタログ JSON（layout_id、placeholders、tags、ヒント値）。
  - ページ要件 JSON（intent、needs、content）。
  - 割付 JSON （layout_id と placeholder→値のマッピング）。
- **フォールバック**: 同点候補のタイブレーク（必須 PH 完全一致 → 文字収容率 → バリエーション → 優先順位）、収容不能時の縮約→分割→付録落とし。

## 4. 非機能・運用要件（概説）
- **バージョニング**: テンプレ／レイアウト定義／プロンプトをバージョン管理し、差分抽出を自動化。
- **多言語対応**: フォント置換・禁則・右左書字のポリシーを定義（初期リリースは日本語に限定）。
- **アクセシビリティ**: コントラスト、読み上げテキスト、代替テキスト生成を中長期で検討。
- **パフォーマンス**: 30 枚資料を 60 秒以内、テンプレ解析は 1 ファイル 30 秒以内。
- **セキュリティ**: 機微情報のマスク、NG ワード検査、メタデータ監査を実装候補に挙げる。
- **監査**: 生成時のテンプレ版、layout_id、処理ログ、差分を記録。
- **残課題**: 枚数と付録境界、縮約優先順位、禁則辞書・許可辞書、多言語対応範囲の調整。
- **運用タスク**: ゴールデンサンプル PPTX の維持、テンプレ差し替え時の自動検証ジョブ、失敗時のリトライ設計（再生成時間 5 分以内を目標）。

## 5. HITL（工程③・④）の方針
- **承認ポイント**
  - (3) コンテンツ承認: スライド候補単位でタイトル・本文・表・意図タグを確定。
  - (4) ドラフト承認: 章立て・ページ順・layout_hint を確定し、付録送り／統合を判断。
- **承認ゲート基準**
  - (3): `title` と本文が存在する、intent 設定済み、数値・単位が明確。
  - (4): 全スライドが章に所属、本編枚数が上限内、各スライドに layout_hint がある。
  - 未充足は承認ボタンを非活性化し、理由を可視化。
- **承認 UI イメージ**
  - ③: コンテンツボード（カード表示、AI アシストで要約/拡張/箇条書き化、表の直接編集、意図タグのプルダウン、承認／付録へ／削除／統合ボタン）。
  - ④: ストーリーボード（章レーンとスライドカード、ドラッグで順番や章を変更、layout_hint の候補表示、付録への移動ボタン）。
- **部分承認とロック**: 承認済み要素はロックし再生成で上書きしない。差戻し時は未承認部分のみ再生成。
- **役割と権限**: Editor（編集・部分承認）、Approver（最終承認）、Viewer（閲覧）を想定。
- **ログ**: 承認イベント（誰がいつ何を確定）と差戻し理由を記録し、slide_uid で工程間トレース。
- **差戻しフロー**: 問題カードにピン留めし、再生成対象を特定。承認保留や付録化提案をUI上で提示。
- **レビュー UI 共通要素**: 差分表示、警告バッジ、ショートカット操作（短く/長く/箇条書き化 等）、編集履歴とロールバック、承認ボタンの活性化制御。

## 6. AI レビュー挿入案
- **位置づけ**: ③/④ のユーザー承認前に AI レビューを自動実行し、合格で承認 UI へ、不合格は改善提案付きで差戻し。
- **レビュー出力形式**
  1. サマリー（グレード、強み/改善点）
  2. 改善アクション（スライド単位のパッチ、適用/却下ボタン付き）
  3. リスク・警告（曖昧語、単位抜け、冗長等）
  4. Auto-fix セット（安全な軽微修正のみワンクリック適用）
- **評価レベル**
  - A: 軽微修正 → 承認 UIへ。
  - B: 要改善 → Auto-fix 適用かユーザー修正。
  - C: 不合格 → 自動リライト案付きで差戻し、対象スライドのみ再レビュー。
- **チェック観点**
  - ③: 明瞭性、簡潔性、一貫性、定量の健全性、構造化適切性、トーン適合。
  - ④: 章テンプレ適合、流れ、冗長/欠落、枚数バランス、layout_hint 妥当性。
- **実装メモ**
  - 静的チェッカー（必須項目、書式、数値整合）＋ LLM クリティークのハイブリッド。
  - 変更は必ず「提案→ユーザー適用」で行い、自動上書きを避ける。
  - 再レビューは差分のみ対象とし、Auto-fix の結果も再検証する。
- **メトリクス例**: Auto-fix 適用率、再レビュー回数、承認後の差戻し率。

## 7. 共通制約とフォールバックポリシー
- **画像・チャート**
  - 画像生成／外部取得は禁止。ロゴ配置のみ自動化。
  - チャートはテキストや表から構造化できる場合に限り表形式で表現し、非構造データは本文として保持。
- **テンプレ依存スタイル**
  - フォント・色・段落はテンプレ側で完結。後工程でスタイルを上書きしない。
- **出力の揺らぎ**
  - LLM による自然な表現差を許容。構造・章立て・枚数は安定させる。
- **フォールバック階層**
  1. 文章側調整（要約／補強／箇条書き化）
  2. 書式調整（フォントサイズ・行間・段落）
  3. レイアウト切替（似た構造のテンプレへチェンジ）
  4. 構成調整（分割／付録送り／省略）
- **失敗時の扱い**
  - レイアウト不一致・PH 欠落は候補落ちとしてログ化。
  - 収容不能は縮約→分割→付録を自動適用し、ユーザーには結果を提示。
  - 5→4 差戻し時には問題スライドに対処ガイドを表示。

## 8. UI/UX に対する要求
- JSON は内部形式とし、ユーザーには自然言語・カード UI・グラフィカルな操作のみ提供。
- AI は「人が理解できる表現」への変換と、編集内容を内部 JSON に戻す通訳役に徹する。
- レビュ UI の必須要素: 差分表示、警告バッジ、ショートカット操作、承認済み要素のロック、履歴とロールバック、再生成トリガー。
- ユーザー補助: AI の提案（短く・詳しく・比較用に整形・意図変更）、表の自動列名提案、単位統一。
- 失敗時フォールバック: タイムアウトは保留扱い、必須項目欠落は承認不可、構成オーバーは付録送り/統合を提案。

## 9. 今後のドキュメント化・タスク化のヒント
- 組織向けテンプレ整備ガイド（命名規約・検証手順）を `docs/policies` 系に追加。
- レイアウト選定エンジンとスコアリング指標の詳細設計を `docs/design/` に展開。
- HITL 承認ワークフロー（状態遷移・権限・UI仕様）の別紙化。
- AI レビューのプロンプト雛形と結果スキーマの定義。
- 非機能要件（性能・セキュリティ・監査）の数値指標とテスト方針を `docs/requirements/` へ反映。
- 承認ログと生成ログを連携させ、監査レポートテンプレートを用意（承認履歴、差分、Auto-fix 適用状況を一覧化）。
- UI ワイヤーやユーザーフロー図を作成し、`docs/design/` で共有できるようにする。
