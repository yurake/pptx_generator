パワポ作成エージェント設計

user
パワポ作成Agentを作成しようと企画しています。
インプットはパワポ作成に必要なデータと、パワポのテンプレートで、アウトプットはパワポです。

> メモ: 現在のスコープでは専用 UI は実装対象外とし、HITL 承認は API／CLI ベースで運用する方針に更新済み。以下に登場する UI/UX 案は将来バックログ。

以下フローで考えています。
	•	[ ] テンプレ作成
	•	[ ] テンプレからtext情報取得
	•	[ ] コンテンツ作成
	•	[ ] コンテンツからドラフト作成
	•	[ ] ドラフトとtext情報で仮加工json
	•	[ ] jsonからpptx生成


この内容をもとに、フローを具体化し、不足している情報や処理、不透明なことがないか洗い出して。

ChatGPT
良い構想です。PowerPoint作成エージェントを設計する際の典型的な課題は、  
**「テンプレート情報の抽出精度」** と **「コンテンツとスライド構造の整合性」** です。  
以下で、あなたのフローを基にした詳細化と、不足・不透明な点を整理しました。  

---

## 🧭 全体フローの具体化

### 1 テンプレ作成
- **目的**: スライドのスタイル、レイアウト、フォント、配色などを統一化。
- **処理**
  - PowerPointテンプレ（`.potx`）または `.pptx` ファイルを準備。
  - スライドマスター・レイアウト名・プレースホルダ構造（タイトル/本文/画像枠など）を定義。
- **出力**
  - `template.pptx`
- **不足・検討点**
  - どの段階でテンプレを更新・差し替えるか（静的 or 動的生成？）
  - ブランドカラーやロゴ適用など、固定要素の扱い。

---

### 2 テンプレからtext情報取得
- **目的**: 各スライドレイアウトに何を埋めるか（タイトル枠、本文枠など）を理解。
- **処理**
  - `python-pptx`等でスライドマスターを解析。
  - 各レイアウトごとの `shape.name`, `placeholder_type`, `text_frame` を抽出。
  - `layout_schema.json` のような中間構造にまとめる。
- **出力**
  ```json
  {
    "title_slide": {"title": "", "subtitle": ""},
    "section_slide": {"section_name": ""},
    "content_slide": {"title": "", "body": "", "image": ""}
  }
  ```
- **不足・検討点**
  - 図・グラフなど非テキスト要素の扱い（例: 「画像をここに入れる指示」をどう表現するか）
  - テンプレート更新時にschemaの再生成が必要か？

---

### 3 コンテンツ作成
- **目的**: ユーザー入力データや要約などから、スライド本文の「素材テキスト」を生成。
- **処理**
  - 例えば以下のように情報を生成：
    - 要約AI → メッセージ・チャート・表形式の内容生成
    - LLM（GPT-5等）で文章や図表キャプションを出力
  - 各スライドタイプに対応するJSON構造を生成。
- **出力**
  ```json
  {
    "slides": [
      {"type": "title_slide", "title": "プロジェクト概要", "subtitle": "2025年度方針"},
      {"type": "content_slide", "title": "市場分析", "body": "国内需要は前年比+12%増…"}
    ]
  }
  ```
- **不足・検討点**
  - どの情報ソースを使うか（例: CSV/Excel/Markdown/LLM出力など）
  - 内容生成の粒度：スライド単位か、章単位か？

---

### 4 コンテンツからドラフト作成
- **目的**: コンテンツをスライド構造に配置したドラフトを生成。
- **処理**
  - LLMでスライドの並び・論理構成を決定（例: 「導入→課題→提案→まとめ」）
  - 章立て・ページ順を定義する。
- **出力**
  ```json
  {
    "draft": [
      {"page": 1, "layout": "title_slide", "content_ref": 0},
      {"page": 2, "layout": "content_slide", "content_ref": 1}
    ]
  }
  ```
- **不足・検討点**
  - 見出しの一貫性（セクションタイトル vs ページタイトル）
  - スライド間の接続や重複チェック

---

### 5 ドラフトとtext情報で仮加工JSON
- **目的**: 実際のスライド生成前に、テンプレート構造に沿った中間形式に変換。
- **処理**
  - draftとlayout_schemaをマージして、プレースホルダとテキストを紐付け。
- **出力**
  ```json
  {
    "slides": [
      {
        "layout": "content_slide",
        "placeholders": {
          "title": "市場分析",
          "body": "国内需要は前年比+12%増…",
          "image": "chart1.png"
        }
      }
    ]
  }
  ```
- **不足・検討点**
  - 文字量制御（テキストがプレースホルダを超える場合の対応）
  - 画像・グラフファイルの生成・パス解決

---

### 6 JSONからpptx生成
- **目的**: 実際のPowerPointファイルを組み立てる。
- **処理**
  - `python-pptx`などでテンプレートを読み込み。
  - 各スライドを追加、プレースホルダへテキスト/画像挿入。
  - 書式（フォント・色・段落）をテンプレート準拠で適用。
- **出力**
  - `output.pptx`
- **不足・検討点**
  - 表やチャートを自動生成する場合、matplotlib / Excel埋込をどう扱うか。
  - スライド枚数・章ごとのレイアウト選択ルール。

---

## ⚙️ 不足／不透明な要素の洗い出し

| カテゴリ | 不明点・検討課題 | 対応方針（例） |
|-----------|----------------|----------------|
| テンプレ解析 | 図表・SmartArt・アイコンなど非テキスト構造を扱うか？ | 初期版ではtextプレースホルダ中心に限定 |
| コンテンツ入力 | 元データ形式の標準化（Markdown, JSON, CSV） | Markdownを推奨（構造化しやすく、自然言語も保持） |
| 構成ロジック | ページ順序の決定を人手 or LLMで？ | LLM支援で「章構成提案 → 承認」型 |
| 書式調整 | 自動で改行・文字数調整・箇条書き変換 | LLMで自動整形 or `python-pptx`側で制御 |
| ファイル出力 | potx→pptx変換のパス管理 | 一時ファイル出力と出力パス指定を明確化 |
| ログ/トレーサビリティ | どのスライドがどのデータソースから生成されたか | スライドごとに `source_id` メタデータ保持 |

---

## 💡今後のステップ案
1. **PoC (最小構成)**  
   - 固定テンプレ＋Markdown入力＋タイトル＋本文のみで `pptx` 自動生成。  
2. **LLM統合**  
   - 入力データ → スライド内容要約を自動化。  
3. **構成提案フェーズ**  
   - LLMによる章構成・ストーリーフロー自動生成。  
4. **画像・チャート対応**  
   - matplotlibやPILで生成し、スライドに配置。  
5. **UI/API化**  
   - REST API経由で “テンプレ＋データ→pptx” 一括生成。

---

ご希望があれば、  
次に「フロー全体をJSONワークフロー設計図（step-by-step）で整理」することもできます。  
進めますか？

user
1のテンプレ作成について、ユーザーのインプットの他に、アプリ側で事前にテンプレートを用意します。アプリ側のテンプレは数百枚に渡るスライドマスターページを用意し、あらゆる表現のレイアウトパターンに対応できるようにします。(パワポを動的に作るのではなく、このテンプレで用意したレイアウトから選んでページを作っていくイメージです)

ChatGPT
いいですね、その前提なら「巨大テンプレートライブラリ」を中核に据えた設計にしましょう。  
下記は“数百レイアウトを事前用意→選択して組み立てる”前提での**具体化プラン**です。

---

# 目標像（要約）
- アプリは **テンプレ資産（マスター群）** を持ち、ユーザー入力＋生成コンテンツに応じて、最適な**レイアウトを選択**してスライドを組み立てる。
- レイアウトは **構造（プレースホルダ）** と **見た目（スタイル）** を厳密に定義・タグ付けし、**ルール＋スコアリング**で機械的に選べる。
- 変更容易性のため、**メタデータ主導**（JSON/YAMLマニフェスト）で管理。

---

# テンプレ資産の構成（推奨リポジトリ構造）
```
/templates/
  /libraries/
    brandA_v1/
      template.potx
      manifest.json            # レイアウト索引（必須）
      /thumbnails/             # レイアウトサムネ
      /examples/               # 使用例pptx（任意）
    brandA_v2/
      ...
    brandB_v1/
      ...
/schemas/
  layout_manifest.schema.json  # manifestのJSON Schema
  content_mapping.schema.json  # コンテンツ→プレースホルダ対応定義
/tools/
  validate_manifest.py         # リンター（CIで使用）
  export_layouts.py            # レイアウト一覧抽出ツール
/docs/
  design_guidelines.md         # 命名規約／作法
```

---

# スライドマスター設計指針
**命名規約（例）**
- レイアウト名：`[カテゴリ]__[機能]__[要素]__[バリアント]`
  - 例：`KPI__Scorecard__3colsSmall__A`
- プレースホルダ名：`PH__[役割]__[順序/位置]`
  - 例：`PH__Title__1`, `PH__Body__Main`, `PH__Chart__Right`

**プレースホルダ種別の標準**
- `title` / `subtitle` / `heading`
- `body`（箇条書き前提） / `note`（小さめ）
- `image` / `chart` / `icon` / `table`
- `label`（短文タグ）/

user
細かい話はまだ。まずは全体の構想策定を進めて。さっき回答してもらったものを育てて

ChatGPT
了解。まずは“全体の構想”を1枚絵で固めます。細部は後続で掘ればOK。  
（前提：アプリ側に数百レイアウトを持つ巨大テンプレライブラリがあり、そこから選んで組む）

# 全体アーキテクチャ（俯瞰）
- **入力面**
  - ユーザー入力（目的・対象読者・必須メッセージ・素材データ）
  - 企業／案件ごとのテンプレライブラリ（ブランド別・言語別）
- **中核**
  - 1テンプレインデクサ（マスター解析・レイアウトカタログ化）
  - 2コンテンツ生成器（要約・整形・表/図の指示文生成）
  - 3レイアウト選定エンジン（要件→レイアウトの自動マッチング）
  - 4ドラフト組版器（章立て・ページ順の自動提案）
  - 5中間JSONアセンブラ（プレースホルダに内容を割付）
  - 6PPTXレンダラ（テンプレから最終PPTX生成）
- **出力面**
  - 最終`pptx`、ドラフト`pptx`、中間JSON、採用レイアウト一覧、ログ

---

# フェーズ別ゴールと主なアウトプット
1) **テンプレ作成 / 管理（資産側）**  
   - ゴール：レイアウトを“機械可読”に管理可能な資産へ  
   - 成果物：テンプレ群（potx/pptx）＋レイアウト辞書（メタデータ）

2) **テンプレからtext情報取得（メタ化）**  
   - ゴール：各レイアウトの構造（タイトル/本文/画像枠…）を定義化  
   - 成果物：レイアウトカタログ（カテゴリ、用途、制約、プレースホルダ仕様）

3) **コンテンツ作成（素材化）**  
   - ゴール：入力データを“スライド素材”に正規化（文・箇条書き・表指示）  
   - 成果物：スライド素材JSON（メッセージ、データ、図表要求）

4) **コンテンツ→ドラフト（構成化）**  
   - ゴール：章立て／ページ順／各ページの目的と要件を決定  
   - 成果物：ドラフト構成（ページごとの意図・必要要素の要件票）

5) **ドラフト×テンプレ情報で仮加工JSON（割付化）**  
   - ゴール：各ページ＝選定レイアウト＋プレースホルダ割付を確定  
   - 成果物：スライド割付JSON（中間表現）

6) **JSON→PPTX生成（具現化）**  
   - ゴール：テンプレ適用で最終PPTXを確実に出力  
   - 成果物：完成`pptx`、自動生成ログ、差分（再生成の再現性担保）

---

# レイアウト選定エンジン（肝）
- **入力**：ページ要件（例：タイトル＋本文＋小画像×2＋注記…）、制約（言語/紙面比率/枚数上限）  
- **処理**：  
  - 1必要要素の**合致度**（必須PHの有無、要素数一致）  
  - 2**容量適合**（文字量・表サイズ・画像アスペクト）  
  - 3**文脈適性**（“KPI要約”“ロードマップ”“二軸比較”など用途タグ一致）  
  - 4**ブランド/言語適合**（フォント・書字方向・色）  
  - 5**美観・一貫性**（直前スライドとのバリエーション管理）  
- **出力**：レイアウト候補リスト（スコア順）＋採用理由（説明可能性）

---

# 主要アーティファクト（シンプルな想定）
- **レイアウトカタログ（例）**
  ```json
  {
    "layout_id": "KPI__Scorecard__3cols__A",
    "placeholders": ["title", "kpi_col1", "kpi_col2", "kpi_col3", "note"],
    "tags": ["kpi","scorecard","3col"],
    "constraints": {"max_title_chars": 60, "supports_images": false}
  }
  ```
- **ページ要件（例）**
  ```json
  {
    "intent": "kpi_summary",
    "needs": {"title": true, "kpi_items": 3, "note": true},
    "content": {"title": "今期の主要KPI", "kpi_items": [...], "note": "データは速報値"}
  }
  ```
- **割付JSON（例）**
  ```json
  {
    "layout_id": "KPI__Scorecard__3cols__A",
    "mapping": {
      "title": "今期の主要KPI",
      "kpi_col1": {...}, "kpi_col2": {...}, "kpi_col3": {...},
      "note": "データは速報値"
    }
  }
  ```

---

# ヒューマン・イン・ザ・ループ（HITL）
- **チェックポイント**
  - A. 章立て案承認（目的・読者に対する妥当性）  
  - B. レイアウト自動選定のプレビュー承認（候補切替・固定化）  
  - C. 重要ページの文言/数値ロック（以降の再生成で保持）  
- **UI**
  - 候補レイアウトのサムネ表示、差し替え可能、説明つき

---

# 非機能・運用要件（最初から意識）
- **再現性**：同じ入力→同じPPTX（乱数/温度/モデル更新の影響を隔離）  
- **バージョニング**：テンプレ/レイアウト定義/モデルプロンプトの版管理  
- **多言語**：フォント置換・禁則・右左書字の扱いポリシー  
- **アクセシビリティ**：コントラスト、読上げテキスト、代替テキストの自動生成  
- **パフォーマンス**：数十ページを可用時間内に生成（例：≤60秒/30枚の目安）  
- **安全**：社名・機微の**リーク防止**（NGワード検査・メタデータ監査）  
- **監査**：どのデータ/プロンプト/レイアウトで生成したかをログ化

---

# MVPのスコープ（小さく始める）
- 固定ブランド×日本語×横16:9  
- レイアウトカテゴリは**5種**（タイトル、セクション、1カラム、2カラム、KPIカード）  
-

user
だから、細かい話はまだだってば。各処理の目的、入出力、処理概要、制約をまとめよう。

ChatGPT
了解。全体構想を“各処理の目的／入出力／処理概要／制約”で揃えて整理します。  
（細部の命名や実装はまだ踏み込みません。）

---

# 0. 前提（アーキテクチャ方針）
- **巨大テンプレライブラリ方式**：アプリ側で数百レイアウトを事前用意し、都度そこから選択して組み立てる。
- **中間表現主導**：テンプレ情報・コンテンツ・ドラフトは**中間JSON**でつなぐ（疎結合）。
- **Human-in-the-loop任意挿入**：ドラフト段階で人手承認を挟める設計。

---

# 1 テンプレ作成（ライブラリ準備）

**目的**  
- 多様な表現ニーズを事前レイアウトで網羅し、後段は“選ぶだけ”で済む状態にする。

**入力**  
- ブランドガイド、既存社内テンプレ、ベストプラクティス例。

**出力**  
- テンプレファイル群（`.potx`/`.pptx`）  
- テンプレ索引メタ（レイアウトの機能タグ・プレースホルダ定義を持つ**テンプレManifest**）

**処理概要**  
- レイアウト作成／整理 → 機能タグ付け → 索引化（Manifest化） → 簡易プレビュー生成。

**制約**  
- レイアウト命名・タグの一貫性（後段の自動選択の前提）  
- 変更互換性（更新時に旧ドラフトが壊れない方針）

---

# 2 テンプレからtext情報取得（構造抽出）

**目的**  
- 各レイアウトの“何をどこに入れるか”を**機械可読**にする。

**入力**  
- テンプレファイル群、テンプレManifest。

**出力**  
- **レイアウト構造JSON**（レイアウトID、プレースホルダ種別、期待値：タイトル/本文/画像/表など）

**処理概要**  
- テンプレ解析 → プレースホルダ構造の抽出 → 構造JSONへ落とし込み。  
- （既知テンプレならManifestをそのまま利用）

**制約**  
- 非テキスト要素（画像・表・グラフ）は“枠あり/なし”“推奨比率”程度の粗い指定に留める（現時点）  
- テンプレ更新時の差分検出方法を用意

---

# 3 コンテンツ作成（素材生成）

**目的**  
- ユーザー提供データから“スライドに載せる素材テキスト/図表指示”を準備する。

**入力**  
- 元データ（テキスト、Markdown、CSV/Excel、画像、要約候補）  
- 目的・受け手・メッセージ（簡単なブリーフ）

**出力**  
- **コンテンツJSON**（スライド候補ごとのタイトル・本文・箇条書き・図表要求・注釈 等）

**処理概要**  
- 要約/整形（必要ならAI支援） → スライド候補単位に分割 → 要素の型付け（タイトル/本文/図表など）  
- 品質ルール（1枚1メッセージ、文字量の上限目安）を付与

**制約**  
- 著作権・秘匿情報の扱い  
- 文字量・読了時間・ナラティブ一貫性の最低基準

---

# 4 コンテンツからドラフト作成（構成設計）

**目的**  
- 章立て・ページ順序・レイアウト割当の**初稿ドラフト**を作る。

**入力**  
- コンテンツJSON、レイアウト構造JSON、テンプレManifest、（任意）ユーザーの章立て方針。

**出力**  
- **ドラフトJSON**（ページ順、各ページのレイアウトID、配置する要素の参照）

**処理概要**  
- 章立て提案 → ストーリーフロー確定 → 各ページに適したレイアウト候補をスコアリング → 選択  
- 必要なら人手承認ポイントをここに設置

**制約**  
- レイアウト選択は**機能適合**（必要要素が入る）を最優先、次に**美観/冗長回避**  
- 枚数・時間の上限（例：15–25枚）を守る

---

# 5 ドラフトとtext情報で仮加工JSON（マッピング）

**目的**  
- 実生成前に「どのプレースホルダへ何を入れるか」を確定した**マッピング中間表現**を作る。

**入力**  
- ドラフトJSON、レイアウト構造JSON、コンテンツJSON。

**出力**  
- **レンダリング準備JSON**（slideごとに：レイアウトID／placeholder→値、画像パス、表データ等）

**処理概要**  
- プレースホルダ↔要素の対応付け → 文字量の簡易チェック → 画像/表の参照解決  
- 軽微な整形（箇条書き化・禁止語/不適切表現の修正）

**制約**  
- 文字溢れ時の方針（自動短縮／別スライド分割／警告）  
- 図表データの存在確認（欠損時はフォールバック）

---

# 6 JSONからpptx生成（レンダリング）

**目的**  
- 中間表現に従って、テンプレから**最終pptx**を生成。

**入力**  
- レンダリング準備JSON、テンプレファイル群、メディア（画像/アイコン/表データ）。

**出力**  
- `output.pptx`（最終成果物）

**処理概要**  
- 指定レイアウトのページを追加 → プレースホルダへテキスト/画像/表を流し込み → セクション分割/目次更新（任意）  
- 生成後の整合チェック（空枠検出、改ページ不整合）

**制約**  
- テンプレの書式に**上書きしない**（見た目はテンプレ依存）  
- OS/Officeバージョン差異の影響を最小化（互換設定）

---

# 7 品質チェック（自動）

**目的**  
- 体裁・一貫性・漏れの**自動検査**でリワークを減らす。

**入力**  
- 生成済みpptx、レンダリング準備JSON。

**出力**  
- **チェックレポート**（警告/エラー一覧）

**処理概要**  
- 空プレースホルダ、長すぎるテキスト、禁則、用語ゆれ、解像度不足画像、重複スライド などの検知

**制約**  
- 強制エラーと警告の線引き（自動停止 or 続行）

---

# 8 監査・追跡（任意）

**目的**  
- どのスライドがどのデータから来たかを**追跡可能**にする。

**入力**  
- レンダリング準備JSON、データソース識別子。

**出力**  
- **メタデータ付与pptx**（ノート欄やカスタムプロパティに出所メタ）

**処理概要**  
- スライド単位で `source_id` / `content_hash` を埋め込み

**制約**  
- 機密情報のメタ付与は最小限（公開配布物への露出防止）

---

## 横断の非機能制約（抜粋）
- **再現性**：同じ入力とテンプレで同じ出力（決定的処理）  
- **拡張性**：テンプレ追加時にコード改修不要（Manifest駆動）  
- **ガバナンス**：ブランド逸脱をテンプレ側で抑止（後段で書式変更しない）  
- **パフォーマンス**：100ページ級でも待てる時間内（バッチ生成前提）  
- **セキュリティ**：入力データの一時保存・削除方針

---

## いま未確定なポイント（次に詰めると良い論点）
- **レイアウト選択ロジック**：完全自動／半自動（候補提示→選択）  
- **文字量超過の扱い**：自動要約／分割／人手修正の優先順  
- **表・グラフ**：初期は画像貼付で簡素化 or ネイティブ表・チャートを使うか  
- **承認フロー**：どの段で人手承認を入れるか（4 or 5の後）

---

必要なら、この枠組みを**1枚ものの「要求仕様（SRS）テンプレ」**に落としてお渡しします。

user
0前提について、この処理の最後まで人間は介入しない前提です。最初にテンプレートとデータを提供し、出力されたパワポを最後に人間が微修正するだけです。

ChatGPT
了解。**フル自動（最終微修正のみ人手）**前提にアップデートして、各処理を「目的／入力／出力／処理概要／制約・フォールバック」でそろえます。細部の実装や命名はまだ踏み込みません。

---

# 0. 前提（更新）
- **HITLなし**：テンプレ＋データ投入→自動生成→最終PPTXのみ人手で微修正。
- **決定性**：同一入力は同一出力（温度0、同一テンプレ版、同一ルール）。
- **ポリシー駆動**：長文溢れ・欠損・体裁エラーは**ルール化された自動フォールバック**で解決。
- **監査可能**：各スライドに生成根拠（source_id等）をメタ付与。

---

# 1 テンプレ作成（ライブラリ準備）

**目的**  
- 幅広い表現をレイアウトで網羅し、後段は選択のみで成立させる。

**入力**  
- 事前用意のテンプレ群（.potx/.pptx）、ブランドガイド。

**出力**  
- テンプレ本体、テンプレManifest（レイアウトID／用途タグ／PH仕様／制約）、サムネ。

**処理概要**  
- レイアウト設計→タグ付け→Manifest化→軽い静的検証（PH重複・欠損チェック）。

**制約・フォールバック**  
- 互換性：テンプレは**後方互換版管理**。見つからない版→直近互換版を選択。  
- 禁止：後段でデザイン上書きは禁止（見た目はテンプレ依存）。

---

# 2 テンプレからtext情報取得（構造抽出）

**目的**  
- 各レイアウトの「入れ物」を機械可読化（PH種別・長さ目安・許容要素）。

**入力**  
- テンプレ、テンプレManifest。

**出力**  
- レイアウト構造JSON（layout_id, placeholders[], constraints）。

**処理概要**  
- スライドマスター解析→PH種別抽出（title/body/image/table/chart等）→長さ・配置制約を附帯。

**制約・フォールバック**  
- 解析不能PHは**汎用body**として扱う。  
- 不正レイアウト（PH欠損）は**候補落ち**。

---

# 3 コンテンツ作成（素材生成）

**目的**  
- 入力データをスライド素材へ正規化（タイトル/本文/箇条書き/図表指示/画像参照）。

**入力**  
- ユーザーデータ（Markdown/CSV/Excel/JSON/画像等）、目的・受け手・尺（枚数/時間）。

**出力**  
- コンテンツJSON（スライド候補単位の素材ブロック＋意図タグ）。

**処理概要**  
- 要約・正規化（箇条書き化、表・図の要件化、単位統一、数値フォーマット）。  
- 文字量見積（平均行幅×行数×PH制約→目安文字数を算出）。

**制約・フォールバック**  
- PII/機微検知→マスクポリシー適用（例：会社名は許可ドメインのみ通過）。  
- 画像欠損→プレースホルダを**説明文ブロック**へ代替。  
- 目安超過→**縮約（優先度キー保持）**または**自動分割**。

---

# 4 コンテンツからドラフト作成（構成設計）

**目的**  
- 章立て・ページ順・ページごとの要件票（必要要素）を機械的に確定。

**入力**  
- コンテンツJSON、レイアウト構造JSON、制約（最大枚数・章数・言語）。

**出力**  
- ドラフトJSON（ページ順／ページ意図タグ／必須要素リスト）。

**処理概要**  
- ストーリーパターン（例：導入→課題→解決→実行→効果）をテンプレ化し自動適用。  
- 枚数上限内での**自動凝縮**（冗長ページ統合・付録化）。

**制約・フォールバック**  
- 上限超過→付録セクションへ自動退避。  
- 章落ち（必須章不足）→警告付加し**必須章を最優先挿入**。

---

# 5 ドラフト×テンプレ情報で仮加工JSON（マッピング）

**目的**  
- ページごとに「どのレイアウトを使い、各PHへ何を入れるか」を確定。

**入力**  
- ドラフトJSON、レイアウト構造JSON、コンテンツJSON、ポリシー（短縮・分割・省略の優先順）。

**出力**  
- レンダリング準備JSON（layout_id／placeholder→値／画像・表参照／注釈）。

**処理概要**  
- レイアウト選定スコアリング（必須PH充足＞容量適合＞用途タグ一致＞多様性）。  
- マッピング後に**文字溢れ・改行・禁則**を静的チェッカで補正。

**制約・フォールバック**  
- 同点候補→**決定表**でタイブレーク：  
  1) 必須PH完全一致、2) 文字収容率、3) 直前スライドとのバリエーション、4) 既定優先度。  
- 収容不可→（A）要約→（B）分割→（C）省略（省略時は末尾に「補足」集約）。  
- メディア比率不一致→自動クロップ（安全枠）＞レター添え。

---

# 6 JSONからpptx生成（レンダリング）

**目的**  
- テンプレを用いて最終PPTXを機械的に生成。

**入力**  
- レンダリング準備JSON、テンプレ本体、メディア資産。

**出力**  
- output.pptx（最終成果物）、生成ログ（レイアウト選定理由・短縮/分割の発生箇所）。

**処理概要**  
- ページ追加→PHへテキスト・表・画像投入→セクション分割・自動目次（任意）。  
- 禁止：テンプレのスタイル上書き。書式はテンプレのまま適用。

**制約・フォールバック**  
- 画像解像度不足→縮小＋「低解像度」警告マーク（非印刷レイヤ）付与。  
- 表がはみ出す→列幅自動調整→限界超なら**表を画像化**して貼付（表記は注釈に残す）。

---

# 7 品質チェック（自動）

**目的**  
- 完成物の体裁・一貫性・安全性を自動検査し、**自動修正可能な範囲は即時修正**。

**入力**  
- output.pptx、レンダリング準備JSON、ブランド/用語ルール。

**出力**  
- チェックレポート（エラー/警告）、自動修正後pptx（同名別版）。

**処理概要**  
- 空PH、禁則処理、句読点ゆれ、用語ゆれ、全角/半角、脚注整合、色コントラスト。  
- 機微語・社名監査（NG辞書／許可リスト）。

**制約・フォールバック**  
- 強制エラー（空白多数・参照メディア欠損）は**自動修正→不可なら付録落とし**。  
- 警告はレポートのみ（例：やや文字過多）。

---

# 8 監査・追跡（自動）

**目的**  
- 「何を根拠にどのスライドができたか」を後から辿れるようにする。

**入力**  
- レンダリング準備JSON、データソースID、テンプレ版、生成ポリシー。

**出力**  
- pptxのドキュメントプロパティ／ノート欄に`source_id`/`content_hash`/`template_version`等を埋込。

**処理概要**  
- スライド単位で出所メタ付与、生成ルールのハッシュを格納。

**制約・フォールバック**  
- 外部配布前に**機微メタ自動削除**オプションを提供（配布モード）。

---

## 横断ポリシー（自動化の肝）
- **長文溢れ**：優先度タグ（Keep/Trim/Drop）に従い段階的縮約→分割→省略。  
- **枚数上限**：本編上限を厳守。溢れは付録へ。  
- **表・グラフ**：初期は「画像化して貼付」を既定。ネイティブ表は列幅最適化の上限を超えたら画像化。  
- **画像扱い**：推奨アスペクト不一致は自動クロップ、安全マージン内で中央寄せ。  
- **多様性管理**：同系レイアウトの連続を避ける（n枚以内に同型利用は1回まで等）。  
- **決定性**：スコアリングとタイブレーク規則を固定し、乱数排除。  

---

## 成果物（出力束）
1) **最終`output.pptx`**  
2) **生成ログ**（採用レイアウト・縮約/分割・警告一覧）  
3) **チェックレポート**（エラー/警告分類）  
4) **中間JSON**（ドラフト・マッピング）—再現性/再生成用

---

## いまの前提で残る論点（記述のみ／意思決定は後続）
- **最大枚数・付録の扱い**（例：本編20±5、付録無制限）  
- **縮約優先順**（見出し＞本文＞注釈、などの固定順）  
- **許可／禁止辞書の初期セット**（社名・製品名・法令・NG語）  
- **多言語時のフォント/禁則**（今回は日本語想定でOKならスキップ）

---

必要なら、この枠組みを**SRS（要求仕様）ひな形**に展開します。次は「各ポリシーの既定値（数値・閾値）セット」を作りますね。

user
1 事前用意のテンプレはpptxで。出力はテンプレ本体のみ。メタ情報取得は2で実施。

ChatGPT
了解。1を「**テンプレ本体のみ出力**／メタは2で抽出」に合わせて更新します。  
（他フェーズとの受け渡しも最小限で明記）

# 1 テンプレ作成（ライブラリ準備）—更新版
**目的**  
- 多様な表現ニーズを満たす **PPTXテンプレ“本体”のみ** を事前整備し、以降の自動生成で使い回す。

**入力**  
- ブランドガイド／既存社内テンプレ／ベストプラクティス例。

**出力**  
- **テンプレPPTX**（複数：ブランド別・言語別・レイアウト多種）  
  ※この段階では**メタ情報（構造・タグ・制約）は一切出さない**。

**処理概要**  
- スライドマスター／レイアウトの設計・改修  
- 書式（フォント・配色・段落）とプレースホルダ配置の確定  
- 見た目の微調整（余白・グリッド・コントラスト）  
- 簡易ビジュアル検証（崩れ／重なりのみ人手チェック）

**制約・フォールバック**  
- 後段（2）での**機械抽出がしやすい構造**に留意（PHはマスター配下に正しく配置、図形の直描きは最小）  
- スタイルはテンプレ側で完結（後段で上書きしない想定）  
- 版管理：**PPTXのバージョン名のみ**を明確に付与（例：`brandA_v1.2.pptx`）。互換性は2以降で解決

**次フェーズへの受け渡し（2の前提）**  
- 受け渡すのは **PPTXファイル本体のみ**  
- 2で実施すること：  
  - PPTXからの**構造抽出（レイアウト・プレースホルダ・許容要素）**  
  - 抽出結果を**レイアウト構造JSON**として保存  
  - 文字量目安・画像比率などの**制約メタ**も2側で推定・付与

---

## 影響範囲（簡潔）
- 2「テンプレからtext情報取得」が**唯一のメタ生成ポイント**になるため、2の抽出ロジックの品質が肝。  
- 1では**見た目と配置の正しさ**に専念し、データ的意味付けは2へ完全委譲。  
- テンプレ更新は **PPTX差し替えのみ**でOK（メタ再生成は2が自動で対応）。

user
1はok.

ChatGPT
了解。では**2〜8**を、フル自動前提で「目的／入力／出力／処理概要／制約・フォールバック」を簡潔に固めます。

---

# 2 テンプレからtext情報取得（構造抽出）

**目的**  
- PPTXテンプレ本体から、レイアウト構造と制約メタを**機械抽出**する。

**入力**  
- テンプレPPTX本体（複数想定）

**出力**  
- **レイアウト構造JSON**（layout_id、PH種別/位置、想定要素タイプ）  
- **制約メタ**（タイトル/本文の目安文字数、画像推奨比率、表の列上限 等）

**処理概要**  
- スライドマスター・レイアウト列挙 → プレースホルダ種別判定（title/body/image/table/chart 等）  
- 面積・行間・フォントから“収容目安”を推定 → JSON化  
- 解析不能要素は汎用`body`として扱い、フラグ付与

**制約・フォールバック**  
- 欠損/不整合（PH名なし・重複）は**候補落ち**  
- 画像枠なし×画像要求 → 後段でレイアウト再選定  
- 抽出失敗レイアウトは一覧に残すが**非推奨マーク**で回避

---

# 3 コンテンツ作成（素材生成）

**目的**  
- ユーザーデータを、スライド投入可能な「素材ブロック」（タイトル/本文/箇条書き/図表指示/画像参照）に正規化。

**入力**  
- ユーザーデータ（Markdown/CSV/Excel/JSON/画像 等）  
- 目的・対象読者・本編枚数上限・出力言語

user
ストップ、1つずつ見ていこう

ChatGPT
了解 👍  
1️⃣ は確定ですね。  
次は **2 テンプレからtext情報取得（構造抽出）** に進めますか？

user
0も確定

ChatGPT
了解。では **2 テンプレからtext情報取得（構造抽出）** を、決定事項ベースでコンパクトにまとめます。  
（0・1は確定、HITLなし前提）

# 2 テンプレからtext情報取得（構造抽出）

## 目的
- **PPTXテンプレ本体**から、後工程が自動選定・割付できるだけの**機械可読メタ**（レイアウト構造・収容目安・許容要素）を生成する。

## 入力
- テンプレPPTX（複数想定、ブランド／言語別）
- 解析ルール（標準PH種別マッピング、収容目安推定ルールの定数）

## 出力
- **レイアウト構造JSON**（最低限）
  - `template_id`, `layout_id`, `placeholders[] (type, name, order, bbox or relative_pos)`
- **制約メタ**
  - `text_capacity (title/body 目安文字数)`, `image_aspect (推奨比率)`, `table_limits (列/行の上限目安)`, `allowed_types per PH`
- **診断ログ**
  - 抽出不可・不整合レイアウト、警告一覧（後続で自動的に候補除外に使う）

## 処理概要
1. **レイアウト列挙**：スライドマスター配下のレイアウトを走査  
2. **PH抽出と型判定**：title/body/subtitle/image/table/chart/note/icon などに正規化  
3. **収容目安推定**：フォントサイズ・行間・テキスト枠サイズから**可読レンジ文字数**を推定  
4. **メディア制約推定**：画像枠サイズから推奨アスペクト比と最小解像度目安を算出  
5. **JSON化**：レイアウト単位で構造＋制約を保存、テンプレ／版と紐付け  
6. **診断**：PH重複・無名・ゼロ面積・表記ゆれ等を検出しログ化（後続で非推奨扱い）

## 制約・フォールバック
- **抽出失敗PH**：`type=body_generic`で暫定扱い（スコア劣後）  
- **必須PH欠落**（例：タイトル枠なし）：当該レイアウトは**候補落ち**  
- **容量推定の誤差**：±20%レンジで許容し、後段5で**縮約/分割**ポリシーに委譲  
- **画像枠なし×画像要求**：後段5のレイアウト選定で別レイアウトへ自動置換  
- **多言語フォント差**：日本語前提で推定、他言語は係数補正（後日拡張）

## 受け渡し契約（インターフェース最小セット）
- `layouts.jsonl`（レコード単位、1レイアウト=1行）  
  - 必須キー：`template_id`, `layout_id`, `placeholders[]`, `capacity`, `media_guidelines`, `version`
- `diagnostics.json`  
  - `warnings[]`, `errors[]`（`layout_id`紐付け）

## 受入れ基準（Doneの定義）
- 全テンプレで**100%のレイアウト列挙**が完了  
- 重大エラー（必須PH欠落・無名PH）はゼロ、または**候補落ちとして明示**  
- 出力JSONがスキーマ検証に**合格**し、後続3・4でそのまま消費可能

---

次は **3 コンテンツ作成（素材生成）** に進めますか？（同じ粒度でまとめます）

user
収容目安は本当に目安であって制約ではない。なぜなら、入力する文字や情報は生成AIで変更して長くも短くもできるし、パワポの文字サイズやフォント、余白などでいかようにも対応できるため。

ChatGPT
了解。“収容目安＝あくまでヒント（非制約）”に改めて、2を更新します。  
（0・1は確定／HITLなし前提のまま）

# 2 テンプレからtext情報取得（構造抽出）—更新

## 目的
- **PPTXテンプレ本体**から、後工程が自動選定・割付できるだけの**機械可読メタ**（レイアウト構造＋ヒューリスティクス）を生成する。  
- ここで算出するのは**収容“目安”**であり**制約ではない**。後段で文章生成や書式調整により伸縮する前提。

## 入力
- テンプレPPTX（複数可）  
- 抽出ルール（PH種別マッピング、面積やフォントから“目安”を出す係数群）

## 出力
- **レイアウト構造JSON**（`template_id`, `layout_id`, `placeholders[] {type,name,order,rel_pos}`）  
- **レイアウトヒント**（非制約の指標値）
  - `text_hint`：タイトル/本文の**推奨レンジ**（短/中/長のカテゴリ、参考文字幅）  
  - `media_hint`：画像・表の**推奨アスペクト/最小推奨解像度**  
  - `usage_tags`：用途タグ（例：KPI、ロードマップ、比較、2カラム等）
- **診断ログ**（抽出不可・注意喚起）

## 処理概要
1. **レイアウト列挙**：スライドマスター配下の全レイアウト取得  
2. **PH抽出・型付け**：`title/body/subtitle/image/table/chart/note`等に正規化  
3. **ヒント算出**：枠サイズ・既定フォント・行間から**参考レンジ**を推定（短/中/長のカテゴリ化）  
4. **メディア指標**：画像枠の縦横比・ピクセル当量から**推奨比率/解像度**を記録  
5. **JSON化**：レイアウト単位で構造＋ヒントを保存（テンプレ版と紐付け）  
6. **診断**：無名/重複PH、ゼロ面積等を検出しフラグ

## 制約・フォールバック（“非制約”を前提にした運用）
- **収容目安はスコアリング用**：後段5のレイアウト選定・整形の判断材料に使うだけで、**はみ出しは許容**。  
- **自動伸縮ポリシー（後段で適用）**  
  1) **文章側の調整**：要約/簡潔化/箇条書き化（または**情報の補強**で“短すぎ”も埋める）  
  2) **書式側の調整**：フォントサイズ/行間/段落間隔の自動最適化（テンプレのスタイル範囲内）  
  3) **版面側の調整**：同系レイアウトへの切替、プレースホルダの折返し/分割  
  4) **構成側の調整**：分割スライド化または付録送り（必要時）  
- **画像・表の目安**も同様に**参考値**。比率不一致は自動クロップ/レターボックス等で吸収し、不可なら代替レイアウトに切替。

## 受け渡しインターフェース（最小）
- `layouts.jsonl`（1行＝1レイアウト）  
  - 必須：`template_id`, `layout_id`, `placeholders[]`, `text_hint`, `media_hint`, `usage_tags`, `version`
- `diagnostics.json`（`warnings[]`, `errors[]`）

## 受入れ基準
- 全テンプレの**レイアウト網羅**とJSONスキーマ合格  
- 重大不整合（無名/ゼロ面積/必須PH欠落）は**候補落ち**として明示  
- “ヒント値”が後段5のスコアリングで利用可能な粒度で出力されていること

---

この前提で、次は **3 コンテンツ作成（素材生成）** を同じ型（目的/入力/出力/処理概要/非制約の方針）でまとめます。

user
2 ok

ChatGPT
了解。  
現時点で **0（前提）** と **1（テンプレ作成）**、**2（構造抽出）** が確定ですね。  
次は **3 コンテンツ作成（素材生成）** の定義に進めます。  

進めてよければ、同じ粒度（目的／入力／出力／処理概要／制約・フォールバック）で整理します。  
進めますか？

user
はい

ChatGPT
了解です。では次のフェーズ、**3 コンテンツ作成（素材生成）** を定義します。  
（0〜2確定済、HITLなし前提・フル自動生成ライン）

---

# 3 コンテンツ作成（素材生成）

## 目的
- 提供された元データから、スライド構築に使える**素材データ（文章・図表・画像指示など）**を自動生成する。  
- 内容の長短・構成はテンプレや後段制約を前提にAI側で柔軟に最適化する。

## 入力
- **データ群**（任意形式）  
  - テキスト／Markdown／CSV／Excel／画像／構造化データ 等  
- **生成条件**  
  - プレゼン目的（例：報告／提案／説明）  
  - 対象読者（経営層／営業／技術者など）  
  - 希望トーン（正式／カジュアルなど）  
  - 枚数や時間の上限（目安）
- **テンプレ構造情報（2の出力）**  
  - レイアウトカテゴリ、用途タグ、想定スライドタイプ群（例：タイトル／比較／KPI／グラフ）

## 出力
- **コンテンツJSON**（スライド候補単位）
  ```json
  {
    "slides": [
      {
        "intent": "市場動向",
        "type_hint": "content",
        "elements": {
          "title": "市場環境の変化",
          "body": ["国内需要は前年比12%増", "海外市場も回復傾向"],
          "chart_request": "国内外需要推移（棒グラフ）",
          "image_ref": null
        }
      }
    ],
    "meta": {
      "tone": "formal",
      "target_audience": "management",
      "summary": "国内外の市場成長を中心に報告"
    }
  }
  ```

## 処理概要
1. **入力整形**：形式を統一（表・テキストを分離、画像を参照化）  
2. **情報抽出・要約**：重要項目を抽出し、スライド粒度に要約  
3. **カテゴリ分割**：スライド単位（テーマ単位）にグルーピング  
4. **文章生成・整形**：タイトル文、箇条書き、キャプションを生成  
5. **図表指示生成**：表・グラフ候補を抽出し、必要に応じて生成指示を付与  
6. **スタイル適合**：トーン（丁寧さ、文体）を一貫化  
7. **出力正規化**：プレースホルダと要素を対応づけ可能なJSON形式に変換

## 制約・フォールバック
- **文字量や表現形式は制約しない**：後段で短縮／拡張が自在に可能なため、意味保持を優先  
- **情報欠損**：必要要素が不足している場合は「placeholder要素（例：`<データ不足>`）」を残す  
- **冗長性**：同義・重複文が生成された場合は自動スコアリングで1件に統合  
- **表現の一貫性**：語彙・単位・文末調整を自動で統一  
- **視覚素材**：画像・グラフが指定されていない場合は説明文で代替（例：「イメージ図を挿入予定」）  
- **安全性**：固有名詞・社名・機微語をフィルタリングし、必要なら匿名化タグを付与  

## 出力の品質条件（完了基準）
- 全スライド候補に **タイトル＋本文要素** が最低1セット存在  
- JSONスキーマ検証を通過  
- 各スライドに「意図（intent）」タグが付与され、後段ドラフト化（4）で分類可能  

---

この形でよければ、次は **4 コンテンツからドラフト作成（構成設計）** に進みます。進めますか？

user
このシステムの重要な制約を書きます。画像については連携されたロゴのみパワポに反映するが、それ以外は対応しません。画像生成も行わない。チャートやグラフはテキストで受け取ったものをプレゼンとして有効であると判断される場合に、そのまま使用するか非構造のテキストデータを生成AIによって構造化して使用する。

ChatGPT
非常に重要な前提ですね。  
このシステム全体（特に3以降）に適用される**画像／グラフに関する基本制約**として、以下のように明文化しておきます。  

---

# 🔒 システム全体の重要制約（画像・グラフ関連）

## 1️⃣ 画像の扱い（完全固定）
- **外部生成・取得・加工は行わない。**
- **パワポに反映する画像は「連携済みロゴ（固定アセット）」のみ。**
- したがって：
  - LLM等による画像生成（生成AIでの作図・図解）は一切行わない。  
  - データから動的に画像を検索／貼付する処理は実装しない。  
  - ユーザー提供の画像も対象外（使用禁止）。
- **パワポへの画像配置は以下のみ許可**：  
  - テンプレに定義された「ロゴ領域」への固定ロゴ挿入。  
  - それ以外の画像プレースホルダは**未使用または空枠として処理**。  

---

## 2️⃣ チャート／グラフの扱い（限定的対応）
- **入力がテキスト／表形式で明示的にチャート構造を持つ場合のみ対応。**
  - 例）「年度別売上（百万円）: 2022=100, 2023=120, 2024=135」  
  → 構造化可能なため、**自動で表形式JSON化**して使用。  
- **非構造テキスト**（例：「売上は右肩上がり」など）の場合は：  
  - 生成AIによって構造化可能と判断されたときのみ整形して使用。  
  - 構造化できない場合は**文章として本文に保持**し、チャート生成は行わない。
- **チャート生成そのもの**（棒グラフ・折れ線等の描画）は：  
  - 外部描画ライブラリを使用せず、  
  - PowerPointの**標準表機能（テキスト埋込）または既定図形**で表現。  
  - それが困難な場合はチャート領域を**スキップまたは削除**。

---

## 3️⃣ 生成AIの役割範囲（画像・グラフ領域に関して）
| 項目 | 対応方針 |
|------|------------|
| **画像生成** | ❌ 不可（行わない） |
| **外部画像挿入** | ❌ 不可（ロゴ除く） |
| **ロゴ配置** | ✅ 可（テンプレの専用PHに固定配置） |
| **チャート構造化** | ✅ 条件付き（入力がテキストベースで構造化可能な場合のみ） |
| **チャート描画** | ⚙️ 簡易表現のみ（テキスト表／表型データで代替） |
| **画像・グラフ不足時** | ⚠️ 空枠または説明文を挿入（例：「※図解省略」） |

---

## 4️⃣ 運用上の影響（フェーズ別）
| フェーズ | 影響 |
|-----------|------|
| **2構造抽出** | image/chartプレースホルダは解析対象とするが、3以降では使用されない前提でフラグ付与（`"unused": true"`） |
| **3素材生成** | 画像要求はロゴ以外削除。チャートはテキスト表現→構造化変換。 |
| **4ドラフト作成** | image PHは自動スキップ。chart PHは構造化可否で使用可否を分岐。 |
| **5マッピング** | imageなしレイアウトを優先選定。chartは構造化結果に応じて埋込または本文残留。 |
| **6レンダリング** | image PHが未使用の場合は空枠削除。chartが構造化済なら表形式で配置。 |
| **7品質検査** | image空枠・chart未構造の検出とレポート出力。 |

---

## 5️⃣ 明示ポリシー（システム設計文書に記載すべき条項）
> 本システムは、画像およびグラフの自動生成・外部取得を行わない。  
> PowerPoint出力における画像要素はテンプレート内のロゴ枠のみ利用可能であり、  
> それ以外の画像要素は削除または空白扱いとする。  
> グラフは入力テキストから構造化可能な場合のみ表形式として反映し、  
> 非構造データの場合は本文テキストとして保持する。  

---

この制約をもとに、3（コンテンツ作成）の文書を改訂しますか？  
それとも先に「全体共通制約」セクションとして固定しておきましょうか？

user
全体共通制約にして

ChatGPT
了解です。  
これを「**全体共通制約**」として、0（前提）の直後に位置づける形で正式に整理します。  
今後の各フェーズ仕様では、この共通制約を前提として矛盾しないように扱います。

---

# 🔒 全体共通制約（System-wide Constraints）

## 1️⃣ 人的介入
- 一連の処理は**完全自動実行**を前提とする。  
  人手の関与は**入力（テンプレ＋データの提供）**と**最終出力（微修正）**のみ。  
  各処理ステップではHITL（Human-in-the-loop）を設けない。

---

## 2️⃣ 画像の扱い
- **生成／検索／外部取得／動的差替えは行わない。**
- **PowerPoint出力に反映できる画像は「連携済みロゴ（固定アセット）」のみ。**
- 具体的ルール：
  - ロゴはテンプレート内の専用プレースホルダ（PH）にのみ自動挿入。  
  - それ以外の画像枠（例：写真・図解・イラスト）は**使用しない**。  
  - 不要な画像PHは出力時に削除または空白で出力。  
  - 入力データに画像が含まれていても無視する。  

---

## 3️⃣ 画像生成
- **生成AIによる画像・図解・アイコン等の生成は行わない。**
- DALL-E、Stable Diffusion等の利用は禁止。  
- 画像不足時にAIで代替する処理（例：「イメージ図を生成」）も行わない。

---

## 4️⃣ チャート／グラフの扱い
- **テキストとして提供された構造的な数値データのみ利用対象。**
  - 例：「年度別売上: 2022=100, 2023=120, 2024=135」
- **非構造テキスト**（例：「売上は右肩上がり」）は：
  - 構造化可能な場合 → 生成AIが自動で整形し表形式データ化。  
  - 構造化できない場合 → 文章として本文に保持し、グラフは生成しない。
- **チャート描画方針**
  - 外部ライブラリでの画像化は行わない。  
  - PowerPointの**標準表要素**または**テンプレ既存のグラフ領域**をテキストで埋める。  
  - 図形や画像を追加して可視化することはしない。  
  - 構造化不可または空データ時は該当領域を削除。

---

## 5️⃣ フォーマット・書式
- フォント、文字サイズ、余白、レイアウトなどの見た目調整はテンプレート依存。  
  各工程では**テンプレに定義されたスタイル範囲内で自動調整**するが、  
  新たなスタイルの生成・上書きは行わない。  

---

## 6️⃣ セキュリティ・データ取り扱い
- 外部APIや外部画像リソースへのアクセスは行わない。  
- 生成過程で一時的に作成されるファイルは処理完了後に削除。  
- 出力PPTX以外の成果物（中間JSON等）は、再現性目的でのみ保存される。

---

## 7️⃣ 再現性・決定性
- 同一入力データとテンプレートからは常に同一のPPTXを出力する。  
- AI生成部分は**決定的プロンプト＋固定乱数シード**により再現可能。  
- モデル更新やテンプレ差替えによる変動は**バージョン番号**で管理。

---

この共通制約を「0 前提」の直後（0.1章相当）に固定して、  
以降の3〜8すべてがこの条件を前提に動作する形で設計を続けます。  

次は **4 コンテンツからドラフト作成（構成設計）** に進めますか？

user
同一入力データとテンプレートからは常に同一のPPTXを出力する。
これは求めていない。

ChatGPT
了解です。  
つまりこのシステムでは **「同一入力 → 常に同一出力」** ではなく、  
**生成AIによる自然な揺らぎ（文表現や構成のゆらぎ）を許容する**、という設計ですね。  

その意図を踏まえて、該当部分を修正し、共通制約の「再現性」項を以下のように更新します。  

---

# 🔒 全体共通制約（修正版）

## 7️⃣ 出力の一貫性と変動
- 本システムは生成AIを用いるため、**同一入力とテンプレートであっても出力内容に一定の揺らぎを許容**する。  
- 揺らぎの範囲は「意味・構成の一貫性を保った上での自然な表現差」に限定される。  
- 完全再現性よりも、**情報の適切な伝達と自然な言語表現の最適化**を優先する。  
- ただし、テンプレート構造やレイアウト選定のロジックは**決定的**に動作し、  
  出力のばらつきは**文章内容・言い回し・句読点・表現順序**などにとどまる。

---

この修正により：
- AI生成部分は常に“最適化された新しい出力”を生み、  
- ただし構造やスライド数・章立ては安定している、という形になります。  

この更新を反映して共通制約は確定でよいですか？

user
はい。

ChatGPT
了解 ✅  
では現時点の確定内容は以下の通りです。  

---

## ✅ 確定済み構成

### 0. 前提  
- フル自動実行（HITLなし）  
- テンプレ＋データ投入 → 出力PPTX → 人手微修正のみ  

### 🔒 全体共通制約  
- **画像**：連携済ロゴのみ使用。画像生成・外部取得・差替え禁止。  
- **チャート／グラフ**：テキスト構造化可能なもののみ使用。非構造データは本文に残す。  
- **スタイル**：テンプレ依存。上書き・新規デザイン生成なし。  
- **外部アクセス**：外部API・画像リソース呼び出しなし。  
- **データ処理**：一時ファイルは処理完了後削除。  
- **出力変動性**：同一入力でも生成AIによる自然な揺らぎを許容。構造・章立ては安定。  

### 1. テンプレ作成（ライブラリ準備）  
- 出力はPPTX本体のみ。メタ情報の生成なし（2で抽出）。  

### 2. テンプレからtext情報取得（構造抽出）  
- PPTXから構造メタを機械抽出。  
- 収容目安は「制約」ではなく「ヒント」として扱う。  

---

次は **3 コンテンツ作成（素材生成）** の確定稿に進みますね。  
（前回たたき台あり：この共通制約を反映した最終版としてまとめ直します）  
進めてよいですか？

user
はい

ChatGPT
了解です。  
では、全体共通制約（画像生成なし・ロゴのみ許可・チャートはテキスト構造化のみ）を踏まえたうえで、  
**3 コンテンツ作成（素材生成）** の確定版を以下に示します。

---

# 3 コンテンツ作成（素材生成）

## 目的
- 入力データを基に、スライド生成に必要な**素材データ（文章・表・構造化された要素）**を自動で作成する。  
- 生成AIにより、入力内容をプレゼンテーション向けに要約・整理・構造化し、スライド単位の情報ブロックを形成する。  
- この段階では「何をどの順に伝えるか（内容の素材）」までを確定するが、まだレイアウトは決定しない。

---

## 入力
- **データ群**  
  - テキスト、Markdown、CSV、Excel、JSON、その他構造化データなど。  
- **コンテキスト条件**  
  - プレゼンの目的（報告／提案／分析 など）  
  - 想定読者（経営層／顧客／技術者 など）  
  - 表現トーン（正式／中立／カジュアル）  
  - 想定枚数または時間目安（例：10〜15枚／10分程度）  
- **テンプレ情報（2出力）**  
  - 利用可能なレイアウトの種別・用途タグ（例：タイトル／比較／KPI／表など）

---

## 出力
- **コンテンツJSON**（スライド候補単位の構造化データ）  
  ```json
  {
    "slides": [
      {
        "intent": "市場動向",
        "type_hint": "content",
        "elements": {
          "title": "市場環境の変化",
          "body": [
            "国内需要は前年比12%増と堅調に推移。",
            "海外市場は為替影響により成長が鈍化。"
          ],
          "table_data": {
            "headers": ["年度", "国内需要", "海外需要"],
            "rows": [["2023", "120", "95"], ["2024", "135", "100"]]
          },
          "note": "為替前提は110円/ドル"
        }
      }
    ],
    "meta": {
      "tone": "formal",
      "audience": "management",
      "summary": "国内外の市場成長動向を報告"
    }
  }
  ```

---

## 処理概要
1. **入力正規化**  
   - 複数形式（Markdown, Excel, CSVなど）を統一データモデルに変換。  
   - 文章・表・注記などの区分を明確化。  

2. **情報抽出・要約**  
   - テキストや表データから主要メッセージを抽出し、1スライド1メッセージ原則で要約。  
   - 補足的な説明や注記は別要素（`note`）として保持。  

3. **構造化**  
   - スライド候補単位に、タイトル・本文・表・注記などのキーでデータを整理。  
   - テキスト中のリスト構造や箇条書きを自動検出して整形。  

4. **チャート・表データの整形（共通制約準拠）**  
   - テキストや表形式で与えられた数値データのみを対象に、生成AIが構造化を支援。  
   - 構造化不能な記述（例：「売上は右肩上がり」）は本文テキストに保持。  
   - チャート画像は生成しない。PowerPoint表で表現できる範囲に留める。  

5. **表現整形**  
   - トーン、文末表現、用語表記を統一。  
   - 長すぎる段落は後続5の短縮処理を想定しつつ保持（制約を課さない）。  

6. **スライド候補出力**  
   - 各スライド候補を独立した要素群としてJSONにまとめる。  
   - `intent`（伝達目的タグ）と`type_hint`（内容タイプ）を付与。

---

## 制約・フォールバック
- **画像は使用しない**：画像挿入要請があっても無視またはロゴに限定。  
- **チャート生成なし**：描画処理は行わず、構造化可能な数値データのみ表化。  
- **内容量**：長文／短文いずれも許容。後続フェーズでレイアウト適合化を実施。  
- **欠損データ**：不足要素がある場合は`"<未入力>"`や`null`で明示。  
- **不明瞭表現**：曖昧な数値や不完全な表現（例：「少し増加」）は補足説明を追加して保持。  
- **スタイル非干渉**：テンプレ依存の書式（フォント等）はこの段階では扱わない。  

---

## 完了基準（出力の品質条件）
- 各スライド候補に**タイトル＋本文要素**が最低限存在。  
- チャート／表データがある場合は構造化済み、または本文化されている。  
- JSONスキーマ検証を通過し、4（ドラフト構成）に渡せる構造を満たしている。  

---

この3を確定版として次に進めますか？（4 コンテンツからドラフト作成）

user
制約は共通で書いてあるのはわざわざ書かないで

ChatGPT
了解です。  
共通制約で既に定義済みの内容（画像・チャート・生成AIなど）は3から削除し、  
**この工程固有の目的・入力・出力・処理概要のみ**に絞って再整理します。  

---

# 3 コンテンツ作成（素材生成）【確定版】

## 目的
- 入力データを基に、スライド構築に必要な**内容要素（文章・表・構造化情報）**を生成する。  
- データをプレゼン向けに要約・整理し、スライド単位で意味のまとまった情報ブロックを形成する。

---

## 入力
- **データ群**  
  - テキスト、Markdown、CSV、Excel、JSONなどの構造化／非構造化データ。  
- **コンテキスト条件**  
  - プレゼン目的（報告／提案／分析など）  
  - 想定読者（経営層／顧客／技術者など）  
  - 表現トーン（正式／中立／カジュアル）  
  - 想定枚数または時間の目安（例：10〜15枚）  
- **テンプレ構造情報（2の出力）**  
  - レイアウトカテゴリや用途タグ（タイトル／比較／KPI／表など）

---

## 出力
- **コンテンツJSON**（スライド候補単位の構造化データ）
  ```json
  {
    "slides": [
      {
        "intent": "市場動向",
        "type_hint": "content",
        "elements": {
          "title": "市場環境の変化",
          "body": [
            "国内需要は前年比12%増と堅調に推移。",
            "海外市場は為替影響により成長が鈍化。"
          ],
          "table_data": {
            "headers": ["年度", "国内需要", "海外需要"],
            "rows": [["2023", "120", "95"], ["2024", "135", "100"]]
          },
          "note": "為替前提は110円/ドル"
        }
      }
    ],
    "meta": {
      "tone": "formal",
      "audience": "management",
      "summary": "国内外の市場成長動向を報告"
    }
  }
  ```

---

## 処理概要
1. **入力正規化**  
   - 異なる形式のデータを共通データモデルに変換し、テキスト・表・注記を分類する。  

2. **情報抽出・要約**  
   - 主要トピックを抽出し、1スライド1メッセージの原則で要約。  
   - 本文・補足・注記の関係を整理して保持する。  

3. **構造化**  
   - スライド候補単位に、タイトル・本文・表・注記などの要素を構造化。  
   - 箇条書きや段落を自動検出して整形。  

4. **数値データの整理**  
   - テキスト内に存在する定量情報を検出し、表形式へ整形。  
   - 構造化不能な定性的記述はそのまま本文に保持。  

5. **文体統一**  
   - トーン、語尾、表現スタイルを指定条件に合わせて統一。  
   - 長文や短文は後段で調整可能な形で保持（この段階では制約をかけない）。  

6. **スライド候補出力**  
   - 各候補スライドに`intent`（伝達目的）と`type_hint`（内容タイプ）を付与し、  
     後続の4（ドラフト構成）で構成可能なJSON形式で出力する。

---

この3を確定として、次は **4 コンテンツからドラフト作成（構成設計）** に進めてよいですか？

user
続けて

ChatGPT
了解です。  
では次のフェーズ、**4 コンテンツからドラフト作成（構成設計）** の定義を示します。  

---

# 4 コンテンツからドラフト作成（構成設計）

## 目的
- 3で生成されたスライド候補群を基に、  
  全体の**章立て・ページ順・スライド構成**を決定する。  
- プレゼン全体のストーリーフローを自動的に組み立て、  
  各スライドが伝えるメッセージの位置づけを明確化する。

---

## 入力
- **コンテンツJSON（3出力）**  
  - 各スライド候補（intent／type_hint／要素群）  
- **テンプレ構造情報（2出力）**  
  - レイアウトカテゴリ・用途タグ  
- **構成方針**  
  - 想定プレゼン目的（報告／提案／説明など）  
  - 想定読者（経営層／顧客／技術者など）  
  - 想定スライド枚数または時間制限（例：10〜15枚／10分）

---

## 出力
- **ドラフト構成JSON**
  ```json
  {
    "sections": [
      {
        "name": "市場概況",
        "slides": [
          {"ref_id": "s01", "intent": "市場動向", "layout_hint": "overview"},
          {"ref_id": "s02", "intent": "課題整理", "layout_hint": "comparison"}
        ]
      },
      {
        "name": "施策提案",
        "slides": [
          {"ref_id": "s03", "intent": "提案概要", "layout_hint": "one_column"},
          {"ref_id": "s04", "intent": "効果予測", "layout_hint": "table_summary"}
        ]
      }
    ],
    "meta": {
      "target_length": 12,
      "structure_pattern": "report",
      "summary": "市場分析から施策提案までの一連の流れを構成"
    }
  }
  ```

---

## 処理概要
1. **意図クラスタリング**  
   - 各スライド候補の`intent`・`type_hint`をもとにテーマ分類。  
   - 内容の近いスライドを自動でグルーピング。  

2. **章立て生成**  
   - プレゼンの目的に応じて既定の構成テンプレートを適用。  
     例）  
     - 「報告型」：導入 → 実績 → 課題 → 対応策 → 次のアクション  
     - 「提案型」：背景 → 課題 → 解決策 → 効果 → まとめ  
   - 各グループを章として整理し、順序を決定。  

3. **スライド順序決定**  
   - 章内での自然な流れを考慮してスライドを並べ替える。  
   - 冗長・重複する候補はスコアリングにより統合または削除。  

4. **レイアウトヒント付与**  
   - 各スライドの内容タイプと2のテンプレ用途タグを照合し、  
     後続5で使用する`layout_hint`（例：overview／comparison／table_summaryなど）を付与。  

5. **ボリューム調整**  
   - 想定スライド枚数・時間に合わせて自動調整。  
   - 超過分は「付録」章として自動退避。  

6. **出力整形**  
   - 章構造とスライド順を確定し、  
     5（マッピング）でそのまま消費できるドラフトJSONを出力。

---

## 完了基準（出力の品質条件）
- 各スライドが章に所属し、章順とページ順が定義されている。  
- 各スライドに`layout_hint`が付与されている。  
- 出力JSONがスキーマ検証を通過し、5で直接利用可能。  

---

この4を確定として、次は **5 ドラフトとtext情報で仮加工JSON（マッピング）** に進めてよいですか？

user
4ok, 5 plz

ChatGPT
了解です。  
では次のフェーズ、**5 ドラフトとtext情報で仮加工JSON（マッピング）** の定義を示します。  

---

# 5 ドラフトとtext情報で仮加工JSON（マッピング）

## 目的
- 4で確定したドラフト構成と、2で抽出したテンプレ構造情報を突き合わせ、  
  各スライドにおいて「どのレイアウトを使い」「各要素をどのプレースホルダに入れるか」を決定する。  
- 生成AIによる内容整形（短縮・補足・順序調整）を行い、  
  後続のPowerPoint生成処理（6）がそのまま実行できる状態にする。

---

## 入力
- **ドラフト構成JSON（4出力）**  
  - 章構造、スライド順、intent、layout_hint。  
- **テンプレ構造情報（2出力）**  
  - layout_id、placeholders、usage_tags、text_hint（ヒント値）。  
- **コンテンツJSON（3出力）**  
  - 各スライド候補の要素群（title、body、table_data、noteなど）。

---

## 出力
- **レンダリング準備JSON（仮加工JSON）**
  ```json
  {
    "slides": [
      {
        "layout_id": "overview_1col",
        "elements": {
          "title": "市場環境の変化",
          "body": [
            "国内需要は前年比12%増と堅調に推移。",
            "海外市場は為替影響により成長が鈍化。"
          ],
          "table_data": {
            "headers": ["年度", "国内需要", "海外需要"],
            "rows": [["2023", "120", "95"], ["2024", "135", "100"]]
          },
          "note": "為替前提は110円/ドル"
        },
        "meta": {
          "section": "市場概況",
          "page_no": 2
        }
      }
    ]
  }
  ```

---

## 処理概要
1. **レイアウト選定**  
   - 各スライドの`layout_hint`と2のテンプレ用途タグを照合。  
   - 必須要素（title, body, tableなど）をすべて収容できるレイアウトを候補化。  
   - 候補間でスコアリング（適合度／ヒント一致／直前スライドとの多様性）し、最適レイアウトを選択。  

2. **要素マッピング**  
   - 選定されたレイアウトのplaceholdersに、3の要素を割り当てる。  
   - 欠損データは空文字または`null`で保持。  
   - 冗長な要素がある場合は重要度順に割当（例：本文→注記→補足）。  

3. **内容整形**  
   - プレースホルダの長短バランスに合わせ、文章を自動的に再構成。  
     - 長すぎる文は要約または分割。  
     - 短すぎる文は生成AIにより補足して自然な文面に整える。  
   - 表や数値はフォーマット（桁区切り・単位）を統一。  

4. **レイアウト最終適合チェック**  
   - 各プレースホルダに要素が正しく割付されているか確認。  
   - 欠落や不整合があれば、次順位レイアウトを自動再選定。  

5. **JSON構築**  
   - 各スライドについて`layout_id`と`elements`を持つ構造を生成。  
   - セクション名・ページ番号などのメタ情報を付与。  

---

## 完了基準（出力の品質条件）
- すべてのスライドに`layout_id`が割当済み。  
- 各プレースホルダに対応する要素が存在（空であっても構造上の欠損なし）。  
- JSONスキーマ検証に合格し、6（PPTX生成）が直接実行可能。  
- 全スライドの構造・順序がドラフト（4）と一致している。  

---

この5を確定として、次は **6 JSONからpptx生成（レンダリング）** に進めてよいですか？

user
マッピングは機械的にやりますか？それとも生成AIに任せた方が良いですか？メリデメを考えて

ChatGPT
良い質問です。  
5の「マッピング」工程（＝コンテンツ要素をテンプレートのプレースホルダへ対応付ける処理）は、  
**機械的ロジックで行うか／生成AIに任せるか** の設計判断が、  
このシステムの安定性と柔軟性を大きく左右します。  

以下に、両アプローチの**メリット・デメリット／適用指針**を整理します。

---

## 🧩 比較概要

| 観点 | 機械的マッピング（ルールベース） | 生成AIマッピング（LLM支援） |
|------|-----------------------------------|------------------------------|
| **原理** | レイアウト構造JSONの定義（PH名・型）と、コンテンツ要素のキー名をルール照合して対応付け | LLMがスライド内容とテンプレ構造を読取り、最適なプレースホルダ対応を自然言語で推論 |
| **主な処理** | if/elseまたはマッピングテーブルで`title→PH__Title__1`、`body→PH__Body__Main`などを対応 | LLMプロンプトに「この内容をどのPHに配置すべきか？」を問う形で生成 |
| **依存情報** | JSON構造（2出力）＋固定ルールセット | テンプレ説明文（layout名、PH名）＋コンテンツ文脈 |
| **実行コスト** | 低（軽量・決定的） | 中〜高（LLM呼び出し・非決定的） |
| **安定性** | 高（常に同じ結果） | 中（生成モデルのゆらぎあり） |
| **汎用性** | 低（テンプレに依存、未知レイアウトに弱い） | 高（新しいテンプレや曖昧な構造にも対応） |
| **保守性** | 高（ルールが明示的でデバッグ容易） | 中（出力の根拠説明が難しい） |
| **表現柔軟性** | 低（固定対応のみ） | 高（要素の入替・圧縮・統合が可能） |
| **説明可能性** | 明確（対応表を出せる） | 弱い（LLMの判断理由は明示困難） |
| **再現性** | 完全決定的 | 部分非決定的（毎回微差あり） |

---

## 🧠 運用面での実際的な判断

| フェーズ | 機械的処理に適す | 生成AI支援に適す |
|-----------|------------------|------------------|
| **定型レイアウト**（タイトル＋本文、表など） | ✅ ルールベースで十分 | ❌ LLM不要 |
| **複雑レイアウト**（複数カラム・段組・入替可能構成など） | ⚠️ 難易度高 | ✅ AIの柔軟割付が有効 |
| **短時間・大量生成バッチ** | ✅ 安定・高速 | ❌ コスト高・非決定性あり |
| **プレゼン構成の多様性を重視** | ⚠️ 機械だと単調になりがち | ✅ 自然な配置と要約に有利 |

---

## 🏗️ 折衷案（推奨）

最も安定して運用できるのは次の「**ハイブリッド型**」です。

### ● 機械 → AI の二段階構成

1. **機械的マッピング（一次）**  
   - PH名と要素名の一致・型対応で自動割付。  
   - 未マッチ要素を検出して「要確認リスト」に残す。

2. **AI補完マッピング（二次）**  
   - 一次で未割付の要素（例：補足、短文説明、非定型項目）を対象に、  
     LLMが「どのPHに入れるのが自然か」を推論。  
   - 文章圧縮や結合もここで実施（例：「本文が長すぎるため2文に圧縮」）。  
   - 最終的に再度JSON化して出力。

#### メリット
- 決定的な部分はルールで固定（再現性・速度確保）。  
- 非定型部分のみAIが補完（自然さ確保）。  
- テンプレが追加されても対応容易。  

#### デメリット
- 実装が二層構造になる（ログ管理が少し煩雑）。  
- LLMが返すJSON形式の安定化にガード（スキーマ検証など）が必要。

---

## ✅ 結論（このプロジェクトに適した方針）

このシステムの性質：
- フル自動（HITLなし）  
- テンプレは大量・固定化済み（数百レイアウト）  
- 品質よりも**安定・一貫性重視**  
- 出力後に人手微修正あり  

👉 したがって最も整合的なのは：

> **ベースは機械的マッピング、非定型・曖昧要素のみAI補完（ハイブリッド方式）**

---

この方針で5の仕様書に反映させましょうか？  
（つまり：5の処理概要を「機械→AIの2段階マッピング」として再整理）

user
はい。

ChatGPT
了解です。  
それでは、ハイブリッド（機械＋AI補完）方針を正式に反映した  
**5 ドラフトとtext情報で仮加工JSON（マッピング）【確定版】** を示します。  

---

# 5 ドラフトとtext情報で仮加工JSON（マッピング）【確定版】

## 目的
- ドラフト構成（4）とテンプレ構造情報（2）を突き合わせ、  
  各スライドで「どのレイアウトを使用し、どの要素をどのプレースホルダに入れるか」を決定する。  
- 機械的な対応付けを基礎とし、非定型・曖昧な要素のみ生成AIで補完する。

---

## 入力
- **ドラフト構成JSON（4出力）**  
  - 章構造、スライド順、intent、layout_hint。  
- **テンプレ構造情報（2出力）**  
  - layout_id、placeholders（PH構造）、usage_tags、text_hint。  
- **コンテンツJSON（3出力）**  
  - 各スライド候補の要素群（title、body、table_data、noteなど）。

---

## 出力
- **レンダリング準備JSON（仮加工JSON）**
  ```json
  {
    "slides": [
      {
        "layout_id": "overview_1col",
        "elements": {
          "title": "市場環境の変化",
          "body": [
            "国内需要は前年比12%増と堅調に推移。",
            "海外市場は為替影響により成長が鈍化。"
          ],
          "table_data": {
            "headers": ["年度", "国内需要", "海外需要"],
            "rows": [["2023", "120", "95"], ["2024", "135", "100"]]
          },
          "note": "為替前提は110円/ドル"
        },
        "meta": {
          "section": "市場概況",
          "page_no": 2
        }
      }
    ]
  }
  ```

---

## 処理概要
### ステップ1：機械的マッピング（一次処理）
1. **レイアウト候補抽出**  
   - `layout_hint`およびテンプレ用途タグを照合し、収容可能なレイアウトを候補化。  
2. **ルールベース対応付け**  
   - 要素名（title, body, table, note）とPH名（Title, Body, Table, Noteなど）をマッピング表で直接対応。  
   - 未一致要素を「未割付リスト」に残す。  
3. **決定ルール**  
   - 必須要素を全て充足するレイアウトを優先。  
   - 同等候補が複数ある場合はスコアリング（収容要素数・用途タグ一致・直前スライドとの多様性）で決定。

### ステップ2：AI補完マッピング（二次処理）
1. **対象**：一次処理で未割付・曖昧な要素（例：補足文、説明文、短文コメント）。  
2. **生成AIのタスク**  
   - スライド内容とレイアウト構造を入力として、自然な配置位置を推論。  
   - 必要に応じて文章を要約・統合・補足。  
   - 出力はスキーマ準拠JSON。  
3. **検証と反映**  
   - AI出力をスキーマ検証し、構文エラーや空要素を除去。  
   - AIが複数のPHを提案した場合は、スコアが高い方（用途タグ一致率）を採用。

### ステップ3：整形・統合
- 機械的・AI補完後の要素を統合してスライド構造を確定。  
- 各スライドに`layout_id`と`elements`を付与し、ページ順・セクション情報を保持。  
- テキスト・表・注記の整形を行い、6で直接レンダリング可能な形式へ出力。

---

## 完了基準（出力の品質条件）
- 全スライドに`layout_id`が割当済み。  
- すべての必須要素が対応済み（空要素は存在しても構造欠損なし）。  
- 出力JSONがスキーマ検証を通過し、PowerPoint生成処理（6）でそのまま使用可能。  
- ルール適用箇所とAI補完箇所がログに明示されている（再現性と検証性のため）。

---

次は **6 JSONからpptx生成（レンダリング）** に進めてよいですか？

user
はい

ChatGPT
了解。では **6 JSONからpptx生成（レンダリング）** を確定します。  
（共通制約は既に別章で定義済みのため、ここでは工程固有事項のみを記載）

---

# 6 JSONからpptx生成（レンダリング）【確定版】

## 目的
- 5のレンダリング準備JSONをもとに、テンプレPPTXを用いて**最終PowerPointファイル**を自動生成する。  
- レイアウト選択・要素割付済みの内容を、テンプレのスタイルに従って正確に具現化する。

---

## 入力
- **レンダリング準備JSON（5出力）**  
  - `slides[]`（`layout_id`, `elements{title, body[], table_data, note …}`, `meta{section, page_no}` など）  
- **テンプレPPTX（1出力）**  
  - 対応するレイアウト（`layout_id`）を含むテンプレ本体  
- **ロゴアセット（任意）**  
  - テンプレのロゴPHに挿入可能な連携済みロゴ

---

## 出力
- **output.pptx**（最終成果物）  
- **生成ログ（machine-readable）**  
  - 使用テンプレ版、各スライドの`layout_id`、挿入要素数、削除/スキップ要素、表の行列数 など

---

## 処理概要
1. **ドキュメント初期化**  
   - 指定テンプレPPTXをベースに新規ドキュメントを作成  
   - セクション情報（`meta.section`）がある場合はセクションを作成

2. **スライド生成**（スライドごと）
   - `layout_id`に対応するレイアウトでスライドを追加  
   - **テキスト系挿入**  
     - `title` / `subtitle` / `body[]` / `note` を対応PHへ流し込み  
     - 箇条書きは段落単位で挿入、段落レベルは`body[]`の深さで制御  
   - **表データ挿入**  
     - `table_data{headers, rows}` がある場合、テンプレ表領域または標準表を作成し、行列を流し込み  
     - 桁区切り・単位などは5で整形済み前提でそのまま挿入  
   - **ロゴ挿入（任意）**  
     - ロゴPHが存在し、ロゴアセットが指定されていれば挿入（サイズはPHに追従）  
   - **未使用PH処理**  
     - マッピング対象外のPHは空処理または非表示（テンプレ仕様に従う）

3. **ページ付随情報**  
   - ページ番号・フッター・日付はテンプレ設定に従い自動反映  
   - ノート欄に5で付与された注釈やメタを反映可能（オプション）

4. **軽量整合チェック**  
   - 空文字列のみの本文、空表（行列ゼロ）、改行のみのテキストを検出し、削除または警告ログ  
   - レイアウト不一致（存在しない`layout_id`）はログに記録し、そのスライドはスキップ

5. **ファイル出力**  
   - `output.pptx`を書き出し  
   - 生成ログをJSON/テキストで保存（工程名、処理時間、警告件数など）

---

## 完了基準（品質条件）
- すべてのスライドで指定`layout_id`に基づくページが生成されている（欠落スライドなし）  
- 主要要素（タイトル／本文／表など）が正しいPHに挿入されている  
- ドキュメント保存が成功し、ファイルを開いて閲覧可能  
- 生成ログに重大エラー（レイアウト未解決、表データ破損等）が存在しない

---

このまま **7 品質チェック（自動）** に進めますか？

user
7って、それまでの処理で終わってない？いる？

ChatGPT
そうですね。  
あなたの設計方針（全自動＋テンプレ依存＋出力後に人手で微修正）では、**7品質チェック**は独立工程として分ける必要はありません。  

理由を整理します👇

---

### ✅ 7が不要な理由

| 観点 | 説明 |
|------|------|
| **品質保証の主目的** | 5（マッピング）と6（レンダリング）で既に構造・要素整合を検証している。 |
| **検査対象** | 空PH・不整合・表破損などは6のログ出力で自動検出済み。 |
| **修正ポリシー** | 修正はAI再生成ではなく、ユーザーによる最終微修正で完結。 |
| **運用負荷** | 品質検査専用フェーズを設けると二重検証になるだけで効果が薄い。 |

---

### ⚙️ 代替方針（品質確保の位置づけ）

品質管理を残すなら、**6の一部（後段）として統合**します。

> 🔸「軽量整合チェック」  
> 出力直後に自動検査を行い、結果を生成ログに記録する。  
> - 空PH・未使用要素  
> - 不正フォント・未対応レイアウト  
> - 表やテキストのオーバーフロー  
> - 不要スライド（全空要素）  
>
> これらは再生成せず、**ログ報告のみ**。

つまり：
- フェーズとしての「7」は削除  
- チェックロジックは6の中に含めて完結  

---

### 🧾 結論

| フェーズ | 最終構成 |
|-----------|-----------|
| 0 | 前提 |
| 共通 | 全体共通制約 |
| 1 | テンプレ作成 |
| 2 | テンプレ構造抽出 |
| 3 | コンテンツ生成 |
| 4 | ドラフト構成 |
| 5 | マッピング（機械＋AI補完） |
| 6 | PPTX生成＋軽量整合チェック |
| 🚫 | 7 品質チェック → **削除（6に内包）** |

---

次に最後の **8 監査・追跡（自動メタ付与）** を整理して締めましょうか？

user
8も考慮済じゃなかったっけ？

ChatGPT
そのとおりです。  
8（監査・追跡）も、あなたの前提構想ではすでに  
「生成ログを残す（6の一部）」で **カバー済み** です。  

---

### 🔍 状況整理

| 旧フェーズ | 現状 | 状態 |
|-------------|------|------|
| 6 | pptx生成＋ログ出力（テンプレ版・layout_id・要素割付・警告一覧を含む） | ✅ 実装対象 |
| 7 | 品質チェック | ❌ 統合済み（6に内包） |
| 8 | 監査・追跡（source_idやcontent_hashの付与） | ✅ 6のログ出力とメタ保持で代替済み |

---

### 🎯 結論

あなたの設計は最終的に、  
「6フェーズ＋共通制約」という**シンプルで完結した体系**に整理されました。

---

# ✅ 最終フロー構成（確定）

| No | フェーズ名 | 概要 |
|----|-------------|------|
| 0 | **前提** | フル自動、HITLなし、最終微修正のみ人手 |
| 共通 | **全体共通制約** | 画像生成禁止、ロゴのみ使用、チャートは構造化テキスト限定、スタイルはテンプレ依存 |
| 1 | **テンプレ作成** | PPTX本体のみ作成・提供。メタ抽出なし |
| 2 | **テンプレ構造抽出** | プレースホルダ構造・用途タグ・ヒント値をJSON化 |
| 3 | **コンテンツ生成** | 入力データをスライド候補単位の構造化JSONに変換 |
| 4 | **ドラフト構成** | スライド順・章立て・layout_hintを決定 |
| 5 | **マッピング** | 機械マッピング＋AI補完でプレースホルダ割付を確定 |
| 6 | **PPTX生成** | テンプレに従いpptx出力＋軽量整合チェック＋生成ログ記録 |

---

これでシステム設計上のフロー全体は**完結**です。  
必要であれば、この内容をそのまま **「基本設計書（システムフロー定義）」** 形式に整えて出力できます。  
そうしますか？

user
いえ、このフローをどう動かすかのイメージを伝えますので検討してください。
1,2,5,6は全てプログラムのみで完結しますが、3,4はコンテンツやストーリーに直結するため、HITLを検討したいです。前言撤回となり申し訳ありませ？。

ChatGPT
ぜんぜんOKです！3・4だけHITLにする前提で、“どこに人が入るか／何を確定するか／どう次工程へ渡すか”をコンパクトに設計しました。実装は変えずに、**状態管理＋レビュUI＋承認ルール**を足すイメージです。

---

# 方針（要約）
- **1,2,5,6：機械のみ**（今まで通り）
- **3,4：HITL**（人が内容を確定）
- 3→4→5の間に**明示的な承認ゲート**を置き、承認済みのデータだけが下流へ流れる

---

# ワークフロー（状態遷移）
```
(3) コンテンツ作成[auto_draft]
   └─ 人レビュー → [content_reviewing]
         ├─ 修正/追記 → [content_revise]
         ├─ 一部承認（スライド単位）→ [content_partial_approved]
         └─ 全承認 → [content_approved] → (4) へ

(4) ドラフト構成[auto_draft]
   └─ 人レビュー → [draft_reviewing]
         ├─ 並び/章名/layout_hint 修正 → [draft_revise]
         ├─ 一部承認 → [draft_partial_approved]
         └─ 全承認 → [draft_approved] → (5) へ
```

- **不承認**：元の工程に差し戻し（diffが出る）
- **部分承認**：承認済みスライドはロック（以降の再生成で変更されない）

---

# 3/4 に追加するHITLの“やること”
## (3) コンテンツ作成 HITL
- **編集対象**：スライド候補ごとの `title / body[] / table_data / note / intent / type_hint`
- **できる操作**
  - 文面修正／追記（箇条書き化・言い換え）
  - `intent`の付け替え（例：”課題整理”→”背景説明”）
  - 不要候補の削除／重複統合
  - 定量情報の確定（単位、丸め、根拠注記）
- **承認結果**：`content_approved.json`（スライド候補の確定版）

## (4) ドラフト構成 HITL
- **編集対象**：章立て、ページ順、スライドの採否、`layout_hint`
- **できる操作**
  - 章名の変更、章の並び替え／入れ替え
  - 枚数調整（付録送り、本編昇格）
  - `layout_hint`の指定（例：overview / comparison / table_summary）
- **承認結果**：`draft_approved.json`（章構造＋順序＋layout_hint 確定版）

---

# インターフェース（受け渡し契約）
- (3) 出力（承認後）：
  ```json
  // content_approved.json
  {"slides":[
    {"id":"s01","intent":"市場動向","type_hint":"content",
     "elements":{"title":"市場環境の変化","body":["…"],"table_data":{…},"note":null}}
  ],"meta":{"tone":"formal","audience":"management"}}
  ```
- (4) 出力（承認後）：
  ```json
  // draft_approved.json
  {"sections":[
    {"name":"市場概況","slides":[
      {"ref_id":"s01","layout_hint":"overview"}
    ]}
  ],"meta":{"target_length":12,"structure_pattern":"report"}}
  ```
- (5) は **上記“承認済み”JSONのみ**を入力として受け付ける（未承認は通さない）

---

# レビュUIの最小要件
- **差分表示**：自動草案 ↔ 人修正のdiff（追加/削除/変更）
- **警告バッジ**（任意）：曖昧表現・重複・根拠不足・過短/過長のヒント
- **ショートカット**：  
  - “要約（短く）”“膨らませる（長く）”“箇条書き化”  
  - “意図を変更”“付録送り”“レイアウトヒント提案”
- **ロック**：承認済み要素／スライドはロック（再生成しても上書き不可）
- **履歴**：版管理（v1→v2…）とロールバック

---

# ルール（承認ゲートの判定）
- (3) **承認基準**  
  - 各スライドに最低限 `title` と `body(>=1)` がある  
  - 数値・単位・用語の統一  
  - `intent` が空でない
- (4) **承認基準**  
  - すべてのスライドが何らかの章に所属  
  - 本編の枚数が上限レンジ内  
  - 各スライドに `layout_hint` あり  
- **未充足**は承認ボタンを非活性化＋理由をUI表示

---

# 自動再生成との共存（安全策）
- 承認前に “再提案” ボタンでAI再生成可（**承認済み部分は保持**）
- “部分承認→残りだけ再生成” を許容（効率UP）
- (5) で失敗（適合レイアウトなし等）が出た場合は、  
  **(4)に差し戻す**（問題スライドにピン留め＆対処ガイド表示）

---

# 役割と権限（簡易）
- **Editor**：3/4の編集・部分承認まで
- **Approver**：最終承認（次工程へ解禁）
- **Viewer**：閲覧のみ  
（必要なら1人ロールでもOK）

---

# ログと監査（軽量）
- **承認イベントログ**：誰が／いつ／なにを確定したか
- **生成ログ**（既存）：テンプレ版・layout_id・警告一覧
- **追跡ID**：スライドごとに `slide_uid` を持ち、1→6まで同一IDで追跡

---

# 失敗時フォールバック
- **タイムアウト**（一定時間承認なし）：  
  - “保留”として停止（自動スキップはしない）  
- **必須項目欠落**：承認不可＋該当箇所にジャンプ  
- **構成オーバー**：付録へ自動退避の提案をUIで提示

---

# 期待効果
- 3/4で**意味・ストーリー品質を人が担保**、5/6は**機械で安定量産**  
- 差し戻し時の影響範囲を最小化（部分承認＋ロック）
- 最終の微修正（PowerPoint上）を一段減らせる

---

必要なら、このHITLを織り込んだ**画面モック（操作項目の箇条書き＋簡易ワイヤー）**や、  
**状態マシン（JSON定義）**を作ります。どっちから行きます？

user
仕組みを知らないユーザーがjsonをみるのはユーザーフレンドリーではないため、ユーザーが理解しやすい形式、内容に加工させたい(生成AIに任せてみるのもあり)

ChatGPT
いいね、その方向性でいきましょう。  
**内部はJSONで厳密管理、ユーザーは“わかりやすい画面”だけ触る**――という二層設計にします。生成AIは「人が読める表現」への変換と、編集内容を内部JSONへ戻す“通訳”に使います。

---

# ねらい
- ユーザーは**JSONを一切見ない・触らない**。
- 3（コンテンツ）と4（ドラフト）のHITLは、**カード/ストーリーボード/簡易プレビュー**で操作。
- 「承認」「差戻し」「部分承認」「付録へ」など**意味のあるボタン**で判断できる。

---

# ユーザー向け表示（3：コンテンツ作成 HITL）

## 画面：コンテンツボード
- **スライド候補カード**（1枚＝1カード）
  - タイトル（編集可）
  - 本文（箇条書き。1クリックで「短く」「詳しく」「箇条書き化」）
  - 表（表形式で直接編集）
  - 注記（小さなメモ欄）
  - 意図タグ（例：市場動向／課題整理／提案概要…）←プルダウンで変更可
  - ボタン：**承認**／**付録へ**／**削除**／**統合**（他カードと合体）
- **サイドバー：AIアシスト**
  - 要約/拡張/トーン変換（丁寧・中立・カジュアル）
  - 表の列名提案、単位統一
  - 曖昧表現の検出（「やや増加」→定性的注釈に分離 など）

### 見え方イメージ（例）
> **市場環境の変化**  
> - 国内需要は前年比 **+12%**  
> - 海外は為替の影響で横ばい  
> 表：年度別 2023/2024（編集可）  
> 注記：為替前提 110円/ドル  
> 意図：市場動向 ▾  
> [承認] [付録へ] [削除]  AI:（短く）（詳しく）（箇条書き化）

---

# ユーザー向け表示（4：ドラフト構成 HITL）

## 画面：ストーリーボード
- **章のレーン**（導入／現状／課題／解決／効果／まとめ／付録）
  - レーン間はドラッグ＆ドロップでスライド移動
- **カード**（確定内容の簡易プレビュー／タイトル＋先頭2–3行）
  - 右クリック：**layoutヒント選択**（概要／比較／KPI／表要約 など）
  - ボタン：**前へ/後へ**、**付録へ**、**固定**（以降変更ロック）

### 見え方イメージ（例）
> **章：施策提案**  
> [提案概要]（概要）  
> ・3施策を短期/中期で実装  
> [効果予測]（表要約）  
> ・売上+8%／コスト-3% 見込み  
> └ [前へ] [後へ] [付録へ]  Layout: ▾ 概要

---

# 生成AIの役割（ユーザーのための“通訳”）

1) **読みやすい表現への変換**（内部JSON→人向けUI）  
   - タイトル・本文を自然な日本語で整形、長短の調整、表を“読みやすい表”へ。
2) **編集を構造へ戻す**（人の操作→内部JSON）  
   - ユーザーの修正を項目ごとに正規化（タイトル/本文/表/注記/意図タグ）。  
   - 語尾統一、単位統一、数値フォーマットなどを下支え。
3) **アシスト**  
   - 要約、拡張、箇条書き化、冗長削減、重複統合の提案。  
   - 章立てテンプレへの自動当て込み案（ユーザーは採否をクリックするだけ）。

> 重要：**AIは結果を決めない**。UIでのボタン操作が最終的な“確定”イベント。

---

# 操作→内部更新の対応（例）

| ユーザー操作 | 内部で行うこと |
|---|---|
| タイトル修正 | `elements.title` を更新 |
| 箇条書き追加 | `elements.body[]` 末尾に追加 |
| 表の列名変更 | `elements.table_data.headers[i]` を更新 |
| 意図タグ変更 | `intent` を新タグへ更新 |
| 付録へ移動 | 4の`sections`で`Appendix`へ移動 |
| layoutヒント選択 | `layout_hint` を更新（例：`comparison`） |
| 固定（ロック） | 5以降で該当スライドをAI/自動処理から除外 |

---

# 承認ゲート（わかりやすいUI）
- **3承認**：全カードに✅が付いたら「ドラフト構成へ進む」ボタンが活性化。  
- **4承認**：章・順序・layoutヒントが埋まれば「スライド生成へ」ボタンが活性化。  
- 未充足は**赤バッジ**で理由を表示（例：「3枚が意図未設定」「1枚がタイトル未入力」）。

---

# Diff と履歴（読める・戻せる）
- カードごとに**変更履歴**（v1→v2→…）をタイムライン表示。  
- 差分は**旧→新**のハイライト（タイトル差分・本文箇条書き差分・表のセル差分）。  
- 「v2に戻す」ボタンでロールバック。  

---

# 文章品質の“軽いガイド”（赤ペン先生）
- **チェックアイコン**でヒントを表示（あくまで提案・自動修正しない）  
  - 長すぎる／短すぎる  
  - 曖昧語（「やや」「少し」）  
  - 数値の単位抜け  
  - 被り（重複）  
- クリック一発で「短く」「詳しく」「明確に」などのAIアクション（戻せる）

---

# 出力前の期待値合わせ
- 右上に**予想ページ数**と**本編/付録の比率**を常時表示。  
- 「このまま生成すると：本編 14枚／付録 6枚」  
- 気に入らなければ**付録へ送る**・**まとめる**で調整。

---

# なぜユーザーフレンドリー？
- JSONを隠し、**“カード”と“並べ替え”だけ**で意思決定できる。  
- 専門用語を避け、**意味のあるボタン**（承認・付録へ・固定）で操作。  
- AIは**編集アシストと通訳役**に徹し、勝手に決めない。

---

# 実装の勘所（簡潔）
- **ビューモデル**：内部JSON → 表示用オブジェクト（タイトル・本文・表プレビュー・意図）  
- **双方向バインド**：UIの変更 → 差分パッチ → 内部JSONへ確実に反映  
- **スキーマ検証**：保存時にだけ厳格チェック（入力中は寛容）  
- **ロック機構**：承認済み要素は5以降で変更禁止  
- **監査**：承認イベント（誰がいつ何を確定）をログ化

---

必要なら、このUIの**簡易ワイヤー**（テキストベース）や、  
「AIアシスト用プロンプト雛形（“短く”“詳しく”“比較用に整形”など）」を用意します。  
どこから作りましょう？

user
まだ不要です。
あとはユーザー承認に出す前に、AIによるレビューを挟みたい。

ChatGPT
いいね、その一手間でユーザーの負担がグッと減ります。  
**「AIレビュー→（合格なら）承認UIへ」**を、3と4の直後にそれぞれ挟む設計を提案します。

---

# 位置づけ（どこで挟む？）

```
3 コンテンツ作成（auto_draft）
   └ AIレビュー(内容品質) → 合格: 3承認UIへ / 否: 自動リライト→再レビュー

4 ドラフト構成（auto_draft）
   └ AIレビュー(ストーリー整合) → 合格: 4承認UIへ / 否: 改善案付で差し戻し
```

- 3用レビュー＝**内容品質チェック**（文面・表現・定量の整形）
- 4用レビュー＝**ストーリー整合チェック**（章構成・冗長/欠落・流れ）

---

# レビューの出力（人が読みやすい形）

## 1) サマリー（3〜6行）
- 全体評価（A/B/C）
- 強み2点・改善ポイント3点（箇条書き）

## 2) 改善アクション一覧（クリック適用可）
- 「文を短くする」「箇条書き化」「用語統一」「重複統合」「表の列名を明確化」など
- スライド単位の**候補パッチ**（適用/却下ボタン）

## 3) リスク・警告
- 曖昧語・単位抜け・根拠なしの数値・日付の文脈ズレ など（スライド番号つき）

## 4) 自動修正プラン（任意）
- “安全に自動適用可能”な修正のみをまとめた**Auto-fixセット**（ワンクリック適用）

> ※内部的には JSON パッチ（diff）を持ち、UIには人間可読で提示。

---

# レビュー観点（3と4で粒度を変える）

## 3: コンテンツ品質レビュー（スライド候補単位）
- **明瞭性**：1枚1メッセージになっているか／タイトルが要旨を言い切れているか
- **簡潔性**：冗長な語尾・重複・長文段落を検出
- **一貫性**：語句・用語・表記ゆれ（％/パーセント、千円/¥千 など）
- **定量の健全性**：数値＋単位の対／合計と内訳の整合（簡易）
- **構造化の適切性**：箇条書き・表化の候補提示
- **トーン適合**：formal / neutral / casual のガイドに沿う

## 4: ストーリー整合レビュー（章〜全体）
- **章テンプレ適合**：導入→現状→課題→解決→効果→次アクション 等の定石に対するギャップ
- **流れ**：前後依存関係（課題→解決→効果の順）に矛盾がないか
- **冗長/欠落**：同趣旨スライドの統合提案、重要章の不足提案
- **枚数バランス**：本編/付録の比率、各章の過密/過疎
- **layout_hint 妥当性**：内容タイプとの整合（overview/comparison/table_summary…）

---

# 評価とゲート基準

| レベル | 意味 | 次アクション |
|---|---|---|
| A | 良好（小修正のみ） | そのまま承認UIへ |
| B | 要改善（中規模修正） | Auto-fix適用→再レビュー／または承認UIで人修正 |
| C | 不合格（重大欠落/不整合） | 自動リライト案付きで差し戻し（該当スライド/章のみ） |

**自動で弾く条件（例）**  
- タイトル欠落、本文ゼロ  
- 意図タグ未設定（3）／layout_hint未設定（4）  
- 合計値≠内訳合計（表の基本整合が崩壊）

---

# AIレビューの“やり方”設計（実装の勘所）

## 1) ルール＋LLMのハイブリッド
- **静的チェッカー**（決定的）：必須項目、長/短、重複、数値書式、単位
- **LLMクリティーク**（非決定的）：明瞭性、冗長性、流れ、章テンプレ適合
  - 出力を**定型スキーマ**に限定（例：`{"grade":"B","issues":[...],"autofix_patches":[...]}`）

## 2) 変更は“提案→適用”の二段階
- **勝手に上書きしない**。UIで適用/却下を明確にする（承認前でもユーザー主導）
- Auto-fixは「安全」タグの付いた軽微修正のみ（語尾統一、余分なスペース、箇条書き化 など）

## 3) 再レビューの早回し
- パッチ適用後は**差分スライドだけ**を再レビュー（高速化）

---

# 例：3のAIレビュー出力（人間向け表示）

**総評：B｜強み**：数値の根拠が明確／要旨が先頭にある  
**改善**：1冗長な文末×3 2“増加”の曖昧語×2 3表の単位混在

**Auto-fix（安全）**  
- 箇条書き “—である” を “—です” に統一（5箇所）  
- 表「売上」列に（百万円）を付与、値を換算

**提案（要判断）**  
- 「市場動向: 海外」のカードと「為替影響」のカードは**統合**を推奨  
- タイトルを「市場環境の変化」→「市場環境の変化（国内+12%／海外横ばい）」に言い切り修正

[Auto-fixを適用] [提案1を適用] [却下]

---

# 例：4のAIレビュー出力（人間向け表示）

**総評：A**  
- 流れ：導入→現状→課題→解決→効果→まとめ（◎）  
- 改善：章「解決」に2枚連続の重複傾向 → 1枚に統合可  
- 付録候補：詳細データ×3枚

**提案**  
- 「提案概要」スライドのlayoutヒント：`overview` → `one_column+table_note` を推奨（定量が多い）

[統合を適用] [layoutヒントを採用] [却下]

---

# 失敗時の流れ（フォールバック）

- **C評価**：  
  - どこがダメかを**特定スライド/章にピン留め**  
  - 自動リライト案（短く/具体化/統合）を提示  
  - “対象だけ”再レビュー → 合格で承認UIへ

---

# メトリクス（運用で見たい指標）
- Auto-fix適用率、却下率  
- レビュー1回あたりのC→A/B改善率  
- 承認前の平均リライト回数  
- 承認後（5/6での）差し戻し発生率

---

# まとめ（導入メリット）
- **承認前に粗をAIが先に取る** → ユーザーは意思決定に集中できる  
- **“提案→適用”の一手間**で自動上書きの不信感を避ける  
- **ピンポイント再レビュー**で速い

---

必要なら、AIレビューの**プロンプト雛形（3用/4用）**と、  
**レビュー結果スキーマ**（Auto-fixパッチの形式）をすぐ用意します。
