# プレースホルダーアンカー拡張検討メモ（2025-10-09）

## 背景
- `samples/templates/templates.pptx` などのレイアウトでは、`Body Left` や `Logo` といったアンカー候補がプレースホルダーとして定義されている。
- 現行レンダラーは図形名検索で見つからない場合にプレースホルダー名をレイアウトから逆引きしているが、取得したプレースホルダーに対して `insert_picture` / `insert_chart` を呼び出す前提になっている。
- PowerPoint の汎用プレースホルダー（`PP_PLACEHOLDER.OBJECT` など）は `python-pptx` 上で `insert_*` メソッドを持たず、レンダリング時に `AttributeError` が発生してフォールバック座標での描画、もしくは処理失敗に繋がる。

## 調査結果
- `samples/templates/templates.pptx` の `Two Column Detail` レイアウト:
  - `Body Left` / `Body Right` / `Logo` はいずれも `PP_PLACEHOLDER.OBJECT`。`SlidePlaceholder.insert_picture` / `insert_chart` は実装されていなかった。
  - プレースホルダーの `placeholder_format.idx` を使えばスライド作成後に名称が `Content Placeholder n` へ変わっても追跡できる。
- 汎用プレースホルダーに対しては `slide.shapes.add_*` で図形を追加し、座標・サイズをプレースホルダーから転写するのが安定。
- プレースホルダー本体を削除しなければテンプレート編集時の目印を維持できるが、重なり回避のためにテキストはクリアしておく必要がある。

## 方針案
1. アンカー解決結果をまとめるデータクラス（例: `AnchorResolution`）を新設し、プレースホルダー/図形/フォールバックの区別とレイアウト情報を保持する。
2. テーブル・画像・チャート描画処理で `insert_*` 依存を排除し、プレースホルダー経由時は `add_*` に切り替えて座標・サイズを適用する。Picture プレースホルダーでも挙動を統一する。
3. プレースホルダーを保持する場合は `text_frame.clear()` 等で既定テキストを空にし、上に配置した図形と干渉しないようにする。
4. 既存の図形アンカー（非プレースホルダー）向け挙動は変更せず、利用後に `_remove_shape` でアンカー図形を削除する。
5. 回帰テストではテンプレートにプレースホルダーを持つケースを追加し、表/画像/チャートが指定位置へ配置されることを bbox で検証する。

## 次のアクション
- 上記方針をもとにレンダラーのアンカー解決ヘルパをリファクタリングする。
- テスト用テンプレート・サンプルを整備し、`tests/test_renderer.py` にプレースホルダー併用ケースを追加。
- ドキュメントにプレースホルダー命名と運用ガイドの追記を行う。
