---
目的: PrepareCard 主導で generate_ready.json を構築し、カード枚数と内容が確実に反映されるように改修する
関連ブランチ: fix/rm060-stage3-id-enforce
関連Issue: #279
roadmap_item: RM-060 Stage3 ID 整合性強制
---

- [x] ブランチ作成と初期コミット
  - メモ: 既存の `fix/rm060-stage3-id-enforce` ブランチを継続利用する
- [x] 計画策定（スコープ・前提の整理）
  - メモ: 
    - 対象整理（スコープ、対象ファイル、前提）: DraftStructuringStep と MappingStep、CLI `compose` / `mapping` の連携、および prepare_card.json → content_approved のデータフローを精査する。JobSpec からのレイアウト情報と PrepareCard からのカード/本文をどう統合するかを明確化する。
    - ドキュメント／コード修正方針: JobSpec 由来の layout 定義は維持しつつ、generate_ready 側のスライド生成を PrepareCard ベースに変更する。必要に応じてステップ間の中間モデルやマージ処理を追加する。
    - 確認・共有方法（レビュー、ToDo 更新など）: この ToDo で進捗管理し、PR では影響範囲とテスト結果を詳細に記載する。
    - 想定影響ファイル: `src/pptx_generator/pipeline/draft_structuring.py`, `src/pptx_generator/pipeline/mapping.py`, `src/pptx_generator/cli.py`, 関連テスト (`tests/test_cli_integration.py` など)、サンプル JSON。
    - リスク: JobSpec と PrepareCard の ID 整合性が崩れた場合の例外処理、既存レイアウトスコアリングとの互換性、既存テスト資産への影響。
    - テスト方針: CLI 統合テストを中心に回帰を取りつつ、必要な単体テストを追加する。最終的に `uv run --extra dev pytest` を実行する。
    - ロールバック方法: DraftStructuringStep / MappingStep の変更を revert し、従来の JobSpec 主導構造へ戻す。
    - 承認メッセージ ID／リンク: ユーザー返信「はい、進めてください」（2025-11-08）
- [x] 設計・実装方針の確定
  - メモ: DraftStructuringStep で BriefCard を基準に `GenerateReadySlide` を形成し、MappingStep では Draft ドキュメントのカード順を使って要素を合成する方針で整理。JobSpec からはレイアウト定義とアンカー情報のみ参照する。
- [x] ドキュメント更新（要件・設計）
  - メモ: 仕様更新点を `docs/requirements/stages/stage-03-mapping.md` と `docs/design/stages/stage-03-mapping.md` に反映し、generate_ready のスライド数とカード同期を明文化した。
  - [x] docs/requirements 配下
  - [x] docs/design 配下
- [x] 実装
  - メモ: `src/pptx_generator/pipeline/draft_structuring.py` と `mapping.py` を中心にカード主導フローへ改修し、CLI・レイアウト AI の警告ログ調整、テスト更新を実施。
- [x] テスト・検証
  - メモ: `uv run --extra dev pytest` を実行し 157 件すべて成功を確認。
- [x] ドキュメント更新
  - メモ: 要件・設計以外で変更は不要と判断（ロードマップ／runbook／README は影響なし）。
  - [x] docs/roadmap 配下
    - メモ: 更新不要（対象機能の範囲外）。
  - [x] docs/requirements 配下（実装結果との整合再確認）
    - メモ: `docs/requirements/stages/stage-03-mapping.md` を更新済み。
  - [x] docs/design 配下（実装結果との整合再確認）
    - メモ: `docs/design/stages/stage-03-mapping.md` を更新済み。
  - [x] docs/runbook 配下
    - メモ: 変更不要（運用手順に影響なし）。
  - [x] README.md / AGENTS.md
    - メモ: 変更不要（ユーザー向け手順に差分なし）。
- [x] 関連Issue 行の更新
  - メモ: 
- [x] PR 作成
  - メモ: PR #280 https://github.com/yurake/pptx_generator/pull/280（2025-11-09 完了）

## メモ
- 
