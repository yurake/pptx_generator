# 工程3/4 CLI 分離設計（RM-033）

## 目的
- HITL 工程（工程3: ブリーフ正規化 / 工程4: ドラフト構成）の入出力を CLI 経由で個別に扱えるようにし、工程5/6 パイプラインと疎結合にする。
- ブリーフ成果物 (`brief_cards.json`, `draft_approved.json`) を事前に整備したうえで工程5 (`pptx mapping`) や工程6 (`pptx render`) を再実行できるようにする。
- 監査ログやメタ情報を CLI 実行時点で出力し、後続工程のトレーサビリティ向上に寄与する。

## コマンド設計

### `pptx content`
- **用途**: ブリーフ入力（Markdown / JSON）を BriefCard 成果物へ正規化し、工程4以降で利用する監査情報を生成する。
- **引数**:
  - `brief_path`（必須）: ブリーフ入力ファイル。拡張子が `.json` / `.jsonc` の場合は JSON、その他は Markdown として解釈する。
- **主なオプション**:
  - `--brief-policy PATH`（既定: `config/brief_policies/default.json`）: 章構成やストーリーフェーズを定義するポリシー。
  - `--output DIR`（既定: `.brief`）: 生成物の出力先。
  - `--card-limit INT`（任意）: 生成する BriefCard の上限枚数。
  - `--ai-policy PATH` / `--ai-policy-id ID`（任意）: 将来の AI 設定切り替え用プレースホルダー。
- **処理フロー**:
 1. `BriefSourceDocument.parse_file()` でブリーフ入力を正規化（Markdown → 章チャプター化を含む）。
 2. `load_brief_policy_set()` でポリシーセットを読み込み、`BriefAIOrchestrator.generate_document()` を呼び出す。
 3. 生成した `BriefDocument`・メタ情報・生成ログ（スタブ）を `.brief/` 配下へ書き出す。
 4. 監査用に `audit_log.json` を生成し、ポリシー ID・入力ハッシュ・成果物パスを記録する。
- **出力ファイル例**:
  - `brief_cards.json`
  - `brief_log.json`
  - `brief_ai_log.json`
  - `ai_generation_meta.json`
  - `brief_story_outline.json`
  - `audit_log.json`

### `pptx outline`
- **用途**: BriefCard 成果物とレイアウトヒントを基に `draft_draft.json` / `draft_approved.json` / `draft_review_log.json` を生成する。
- **引数**:
  - `spec_path`（必須）: 元の `spec.json`。工程3の成果物は CLI オプションで読み込む。
- **主なオプション**:
  - `--brief-cards PATH`（既定: `.brief/brief_cards.json`）: ブリーフ成果物。
  - `--brief-log PATH`（既定: `.brief/brief_log.json`）: ブリーフレビューのログ（任意）。
  - `--brief-meta PATH`（既定: `.brief/ai_generation_meta.json`）: ブリーフ生成メタ情報（任意）。
  - `--layouts PATH`（任意）: 工程2の `layouts.jsonl`。レイアウト候補スコアの算出に利用。
  - `--output DIR`（既定: `.pptx/draft`）: ドラフト成果物を保存するディレクトリ。
  - `--draft-filename`（既定: `draft_draft.json`）/`--approved-filename`（既定: `draft_approved.json`）/`--log-filename`（既定: `draft_review_log.json`）。
  - `--target-length INT` / `--structure-pattern TEXT` / `--appendix-limit INT`: `DraftStructuringOptions` のパラメータを外部から制御。
- **処理フロー**:
 1. Spec を読み込み（exit code 2 で失敗扱い）、`BriefNormalizationStep` で Brief 成果物を `PipelineContext` へ取り込む。
 2. `DraftStructuringStep` を実行し、章・カード構成を算出。
 3. ステップが生成したドラフト関連ファイルを出力ディレクトリへ保存（既定設定では上書き）。
 4. 付随メタ情報（章数、スライド数、章承認ステータスなど）を抽出し、`draft_meta.json` として保存。
- **出力ファイル例**:
  - `draft_draft.json`
  - `draft_approved.json`
  - `draft_review_log.json`
  - `draft_meta.json`

## 実装方針
- `_run_draft_pipeline` 内で `BriefNormalizationStep` → `DraftStructuringStep` の順に実行し、工程4/5 どちらから呼び出しても Brief 成果物が必須になる構成へ整理する。
- `pptx content` で生成した成果物を `PipelineContext` の artifact に登録し、後続工程でもパス／メタ情報を再利用できるようにする。
- エラーコードは既存 CLI と整合させ、`BriefNormalizationError` → 4, `DraftStructuringError` → 4, その他例外は 1 を想定する。
- CLI 実行結果のサマリを JSON (`audit_log.json`, `draft_meta.json`) として保存し、後続工程や監査ログに転記しやすい形式を定義する。
- `pptx gen` や `pptx mapping` では従来通りステップを内部実行するが、将来的には `pptx content` / `pptx outline` の成果物が存在する場合に最小実行へ切り替えるオプションを検討する（別タスク）。

## テスト戦略
- `tests/test_cli_content.py`
  - ブリーフ入力を与えて `brief_cards.json` などの成果物が生成されることを確認。
  - 無効な入力で `BriefNormalizationError` が発生するケースや `--card-limit` 制御を検証。
- `tests/test_cli_outline.py`
  - `outline` コマンドが `draft_*` ファイルと `draft_meta.json` を生成すること、`--brief-*` オプション経由で Brief 成果物を参照できることを確認。
  - `--show-layout-reasons` の出力内容を検証し、レイアウトスコア内訳が表示されることを担保。
- `tests/test_cli_integration.py`
  - `content` → `outline` → `mapping` → `render` のチェーンが成立し、監査ログに Brief 情報が記録されることを保証。
  - Brief 成果物が欠けた場合に `pptx gen` / `pptx mapping` が exit code 4 で失敗することを確認し、ユーザーが不足ファイルを特定できるようにする。
- `tests/test_rendering_ready_utils.py::test_rendering_ready_to_jobspec_defaults` で `RenderingReadyMeta` 未設定時のフォールバック値を保証し、CLI 連携時に生成メタが欠落してもレンダリングが継続できることを担保する。

## ドキュメント更新
- README の CLI 一覧へ `content` / `outline` の使い方を追加し、工程 3/4 ワークフローのサンプルコマンドを記載。
- `docs/requirements/stages/stage-03-content-normalization.md` と `stage-04-draft-structuring.md` へ CLI 実装の補足を追記。
- `docs/runbooks/story-outline-ops.md` に工程3/4 CLI 導入後の運用手順を反映。
- ロードマップ `RM-033` 項目へ状況更新と CLI コマンド参照リンクを追加。
