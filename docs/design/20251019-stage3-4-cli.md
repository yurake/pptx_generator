# 工程3/4 CLI 分離設計（RM-033）

## 目的
- HITL 工程（工程3: コンテンツ正規化 / 工程4: ドラフト構成）の入出力を CLI 経由で個別に扱えるようにし、工程5/6 パイプラインと疎結合にする。
- 承認済み成果物 (`content_approved.json`, `draft_approved.json`) を事前に整備したうえで工程5 (`pptx mapping`) や工程6 (`pptx render`) を再実行できるようにする。
- 監査ログやメタ情報を CLI 実行時点で出力し、後続工程のトレーサビリティ向上に寄与する。

## コマンド設計

### `pptx content`
- **用途**: 承認済みコンテンツとレビュー ログを検証し、`JobSpec` へ適用済みのスナップショットを生成する。
- **引数**:
  - `spec_path`（必須）: 元の `spec.json`。
- **主なオプション**:
  - `--content-approved PATH`（必須）: HITL で承認済みの JSON。コメント付き JSON も許容し、正規化して書き戻す。
  - `--content-review-log PATH`（任意）: 承認イベントログ。存在する場合はハッシュと件数を集計しメタ出力。
  - `--output DIR`（既定: `.pptx/content`）: 生成物の出力先。
  - `--spec-output FILENAME`（既定: `spec_content_applied.json`）: 承認内容をマージした Spec の保存先。
  - `--meta-filename FILENAME`（既定: `content_meta.json`）: 承認済みコンテンツ／レビュー ログのハッシュ・スライド数などをまとめたメタファイル。
- **処理フロー**:
 1. `JobSpec.parse_file()` で入力 Spec を検証。失敗時は exit code 2。
 2. `ContentApprovalStep` を `require_document=True`, `require_all_approved=True` で実行。
 3. `context.spec` を JSON に書き出し、`content_approved` / `content_review_log` も正規化した JSON として保存。
 4. `content_approved_meta` / `content_review_log_meta` をまとめたメタファイルを出力。
 5. CLI へ主要ファイルのパスを表示し、監査システム向けにハッシュ情報を含める。
- **出力ファイル例**:
  - `spec_content_applied.json`
  - `content_approved.json`（正規化済み）
  - `content_review_log.json`（任意）
  - `content_meta.json`

### `pptx outline`
- **用途**: 承認済みコンテンツとレイアウトヒントを基に `draft_draft.json` / `draft_approved.json` / `draft_review_log.json` を生成する。
- **引数**:
  - `spec_path`（必須）: 工程3適用後の Spec（`content` の出力を想定）。
- **主なオプション**:
  - `--content-approved PATH`（任意）: 工程3の成果物。指定があれば `ContentApprovalStep` を実行し、Spec と突合。
  - `--content-review-log PATH`（任意）: ログを Draft 実行時に併せて記録。
  - `--layouts PATH`（任意）: 工程2の `layouts.jsonl`。レイアウト候補スコアの算出に利用。
  - `--output DIR`（既定: `.pptx/draft`）: ドラフト成果物を保存するディレクトリ。
  - `--draft-filename`（既定: `draft_draft.json`）/`--approved-filename`（既定: `draft_approved.json`）/`--log-filename`（既定: `draft_review_log.json`）。
  - `--target-length INT` / `--structure-pattern TEXT` / `--appendix-limit INT`: `DraftStructuringOptions` のパラメータを外部から制御。
- **処理フロー**:
 1. Spec を読み込み（exit code 2 で失敗扱い）、必要に応じて `ContentApprovalStep` を走らせる。
 2. `DraftStructuringStep` を実行し、章・カード構成を算出。
 3. ステップが生成したドラフト関連ファイルを出力ディレクトリへ保存（既定設定では上書き）。
 4. 付随メタ情報（章数、カード数、章承認ステータスなど）を抽出し、`draft_meta.json`（新規）として保存。
- **出力ファイル例**:
  - `draft_draft.json`
  - `draft_approved.json`
  - `draft_review_log.json`
  - `draft_meta.json`

## 実装方針
- `_run_content_approval_pipeline` と `_run_draft_pipeline` を `cli.py` に追加し、既存の `_run_mapping_pipeline` / `_run_render_pipeline` と同様の責務分離を行う。
- 新コマンドで生成した成果物を `PipelineContext` の artifact に登録し、後続工程でも再利用可能な構造に揃える。
- エラーコードは既存 CLI と整合させ、`ContentApprovalError` → 4, `DraftStructuringError` → 4, その他例外は 1 を想定する。
- CLI 実行結果のサマリを JSON (`content_meta.json`, `draft_meta.json`) として保存し、`audit_log.json` へ転記しやすい形式を定義する。
- `pptx gen` や `pptx mapping` では従来通りステップを内部実行するが、将来的には `pptx outline` / `pptx content` の成果物を検知してスキップするオプションを検討する（別タスク）。

## テスト戦略
- `tests/test_cli_content.py`
  - `content` をサンプルデータで実行し、Spec/コンテンツ/メタファイルが出力されることを確認。
  - 未承認カード（`status!=approved`）が含まれる入力で `ContentApprovalError` を発生させ、exit code 4 を検証。
- `tests/test_cli_outline.py`
  - `outline` コマンドが `draft_*` ファイルを生成すること、`draft_meta.json` に章/スライド数が記録されることを検証。
  - `layouts.jsonl` 未指定時に既定スコアが適用される（fallback でもエラーにならない）ことを確認。
- 既存の `test_cli_integration.py` に `content` → `outline` → `mapping` → `render` のチェーンを追加し、独立 CLI で成果物を連携できることを保証する。

## ドキュメント更新
- README の CLI 一覧へ `content` / `outline` の使い方を追加し、工程 3/4 ワークフローのサンプルコマンドを記載。
- `docs/requirements/stages/stage-03-content-normalization.md` と `stage-04-draft-structuring.md` へ CLI 実装の補足を追記。
- `docs/runbooks/story-outline-ops.md` に工程3/4 CLI 導入後の運用手順を反映。
- ロードマップ `RM-033` 項目へ状況更新と CLI コマンド参照リンクを追加。
