# RM-005 プレゼンストーリーモデラー設計メモ

## 目的
- 工程3（コンテンツ準備）でカード生成時にストーリー骨子を参照できるようにする。
- 工程4（ドラフト構成）で `story_outline` と `layout_hint` の整合を維持するための設計指針をまとめる。
- 実装前にデータフロー・API フック・UI 連携ポイントを整理し、開発タスクの分割と依存関係を明確化する。

## 背景
- 現状、工程3では入力コンテンツを直接スライド素材へ変換しているが、章立てやストーリーフェーズの明示がないため、工程4での構成調整に時間がかかっている。
- RM-005 ではストーリー設計プロセスをドキュメント化し、後続工程で活用できるようメタデータを整備することが求められている。

## スコープ
- ドキュメント整備（企画、要件、設計）。コード実装は対象外。
- `story_outline.json` スキーマと `prepare_card.json` への拡張項目の設計。
- 工程3 UI での表示仕様、工程4 との連携方法のたたき台作成。

## データフロー（案）
1. `story_outline.json` を読み込み、フェーズ・章・メッセージアングルをメモリ上に展開。
2. コンテンツ生成ロジックがカード単位で内容を構成する際、該当章/フェーズのガイドラインを参照し、カードへメタを付与。
3. HITL レビュー UI にて、カードごとのストーリーフェーズや章情報を表示し、必要に応じて再割当できるようにする。
4. 承認後の `prepare_card.json` にストーリー情報を保持し、工程4に渡す。

## API / モジュール差し込みポイント（想定）
- `src/pptx_generator/pipeline/content_normalizer.py`
  - `StoryContext` (新規) を追加し、アウトライン読み込みとカードへのメタ付与を担当するクラスを想定。
- `src/pptx_generator/ui/review`（仮）
  - ストーリーフェーズ表示、再分類 UI の設計を想定。
- `src/pptx_generator/pipeline/draft_structurer.py`
  - 工程4 で `story_outline` と `layout_hint` の整合を確認するバリデーション追加を検討。

## UI 差し込み案
- カード一覧に章情報とフェーズタグをバッジ表示。
- ストーリー整合性チェック欄を追加し、章抜けやフェーズ不足を警告。

## サンプル `story_outline.json`
```json
{
  "story_outline": {
    "version": "0.1",
    "title": "新製品提案",
    "phases": [
      {"id": "intro", "label": "導入", "default_slide_count": 2},
      {"id": "problem", "label": "課題", "default_slide_count": 2},
      {"id": "solution", "label": "解決策", "default_slide_count": 3},
      {"id": "value", "label": "価値", "default_slide_count": 2}
    ],
    "chapters": [
      {
        "id": "ch01",
        "label": "現状の課題",
        "phase_id": "problem",
        "angles": ["市場背景", "顧客課題"]
      },
      {
        "id": "ch02",
        "label": "解決策の全体像",
        "phase_id": "solution",
        "angles": ["サービス構成", "差別化要素"]
      }
    ]
  }
}
```

## リスクと対策
- **HITL 負荷増:** フェーズの粒度が細かいとレビュー負荷が高まるため、初期は 4 フェーズで開始し、改善余地をドキュメントに残す。
- **工程4 との齟齬:** `layout_hint` が章構成と一致しない場合、工程4でエラー把握できるよう警告を設計。
- **バージョン管理:** `story_outline.json` の更新履歴を残し、関連 ToDo / Issue から参照できるよう `docs/todo/` で管理。

## 次のアクション
- 要件・設計ドキュメントのレビュー後、RM-005 の実装タスクを別途切り出す。
- 工程4/5 のロードマップ更新（必要に応じて RM-024, RM-025 へストーリー連携項目を追加）。
